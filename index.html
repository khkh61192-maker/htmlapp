<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>è³‡ç”¢ç®¡ç† V2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html { -webkit-text-size-adjust: 100%; height: 100%; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; -webkit-tap-highlight-color: transparent; min-height: 100vh; background-color: #f8fafc; margin: 0; color: #1e293b; }
        .safe-area-top { padding-top: env(safe-area-inset-top); }
        .safe-area-bottom { padding-bottom: calc(env(safe-area-inset-bottom) + 1rem); }
        .bg-theme-blue { background-color: #3B7695; }
        
        /* éŸ¿æ‡‰å¼æ¨™ç±¤ï¼šæ‰‹æ©Ÿæ»‘å‹•ï¼Œé›»è…¦æ’åˆ— */
        .tab-scroll-container { display: flex; overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch; gap: 4px; padding: 4px; border-radius: 1rem; }
        @media (min-width: 768px) { .tab-scroll-container { flex-wrap: wrap; overflow-x: visible; white-space: normal; justify-content: center; } }
        
        .tab-btn { padding: 0.6rem 1rem; font-size: 0.85rem; font-weight: 800; border-radius: 0.75rem; transition: all 0.2s; flex-shrink: 0; color: #64748b; }
        .tab-btn.active { background-color: #3B7695; color: white !important; box-shadow: 0 4px 10px -2px rgb(59 118 149 / 0.4); }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        input, select, textarea { -webkit-appearance: none; appearance: none; border: none; outline: none; }
        @keyframes modalIn { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .modal-animate { animation: modalIn 0.3s ease-out; }
    </style>
</head>
<body class="pb-32">

    <!-- Header -->
    <nav class="bg-theme-blue text-white shadow-lg sticky top-0 z-30 safe-area-top">
        <div class="max-w-md mx-auto p-4 flex justify-between items-center">
            <h1 class="font-bold text-lg tracking-tight">è³‡ç”¢ç®¡ç†ç³»çµ± (V2026)</h1>
            <div class="flex items-center space-x-2">
                <button onclick="exportData()" class="text-[11px] bg-white/20 px-3 py-1.5 rounded-full font-bold">å‚™ä»½</button>
                <button onclick="triggerImport()" class="text-[11px] bg-white/20 px-3 py-1.5 rounded-full font-bold">æ›´æ–°</button>
                <button onclick="openSettingsModal()" class="text-[11px] bg-white/20 px-3 py-1.5 rounded-full font-bold">è¨­å®š</button>
            </div>
        </div>
    </nav>

    <div class="max-w-md mx-auto p-4 space-y-4">
        <!-- ç¸½è¦½å¡ç‰‡ -->
        <div class="bg-white rounded-[2.5rem] p-7 shadow-sm border border-slate-100 font-bold">
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div><p class="text-xs text-slate-400 mb-1 font-bold uppercase">åœ‹å…§å‚µåˆ¸ (å¼µ)</p><h2 id="totalBonds" class="text-2xl font-black text-indigo-600 truncate">0</h2></div>
                <div class="text-right"><p class="text-xs text-slate-400 mb-1 font-bold text-left uppercase">ç¸½é ä¼°æç›Š</p><h2 id="totalProfitLoss" class="text-xl font-black break-all leading-none">$0</h2></div>
            </div>
            <div class="space-y-3 pt-5 border-t border-slate-100 text-sm text-slate-600">
                <div class="flex justify-between items-center">
                    <span>00720B å¸‚åƒ¹ <span id="priceStatus" class="text-[9px] text-emerald-500 font-normal"></span></span>
                    <span id="domesticPriceDisplay" onclick="openPriceModal()" class="font-bold text-indigo-600 underline cursor-pointer text-lg font-black">$0.00</span>
                </div>
                <div class="flex justify-between"><span>è‚¡ç¥¨ç¸½å¸‚å€¼</span><span id="totalStockValue" class="text-slate-800">$0</span></div>
                <div class="flex justify-between text-emerald-600"><span>ç¾é‡‘ç¸½é¡</span><span id="totalCashValue">$0</span></div>
                <div class="flex justify-between text-rose-400 font-normal"><span>å·²çµç®—åˆ©æ¯</span><span id="settledInterest">-$0</span></div>
                <div class="flex justify-between text-rose-500 font-bold"><span>ä¿¡è²¸ç¸½é¤˜é¡</span><span id="totalCreditBalance">$0</span></div>
                <div class="flex justify-between"><span>è³ªæŠ¼ç¸½é‡‘é¡</span><span id="totalPledgeAmt" class="text-slate-800">$0</span></div>
                <div class="flex justify-between text-rose-600 font-bold"><span>æœªçµç®—åˆ©æ¯</span><span id="unsettledInterest">-$0</span></div>
                <div class="flex justify-between pt-2 border-t font-black text-slate-700 bg-slate-50 p-2 rounded-lg">
                    <span>ç¸½è³‡ç”¢ (æ·¨å€¼)</span>
                    <span id="totalAssetsDisplay" class="text-indigo-700">$0</span>
                </div>
                <div class="flex justify-between font-bold text-slate-400 text-[10px] px-2 italic font-normal"><span>ç›®å‰å„é …è³‡ç”¢å¸‚å€¼åŠ ç¸½</span><span id="marketValue">$0</span></div>
            </div>
        </div>

        <!-- Tab å°è¦½åˆ— -->
        <div class="sticky top-[75px] z-20 bg-slate-50/80 backdrop-blur-md py-2">
            <div class="bg-white p-1 rounded-2xl shadow-sm border border-slate-100 tab-scroll-container no-scrollbar text-slate-800">
                <button onclick="switchTab('records')" id="tab-records" class="tab-btn active">äº¤æ˜“</button>
                <button onclick="switchTab('stocks')" id="tab-stocks" class="tab-btn">è‚¡ç¥¨</button>
                <button onclick="switchTab('cash')" id="tab-cash" class="tab-btn">ç¾é‡‘</button>
                <button onclick="switchTab('dividends')" id="tab-dividends" class="tab-btn">é…æ¯</button>
                <button onclick="switchTab('pledge')" id="tab-pledge" class="tab-btn">è³ªæŠ¼</button>
                <button onclick="switchTab('loan')" id="tab-loan" class="tab-btn">ä¿¡è²¸</button>
                <button onclick="switchTab('overseas')" id="tab-overseas" class="tab-btn">åœ‹å¤–</button>
                <button onclick="switchTab('reports')" id="tab-reports" class="tab-btn">å ±è¡¨</button>
            </div>
        </div>

        <div id="mainContentView" class="space-y-3 min-h-[300px] text-slate-800"></div>
    </div>

    <!-- åº•éƒ¨æ–°å¢æŒ‰éˆ• -->
    <div class="fixed bottom-0 left-0 right-0 p-4 bg-white/80 backdrop-blur-xl border-t border-slate-100 z-40 safe-area-bottom text-center text-white">
        <div class="max-w-md mx-auto"><button onclick="openModal()" class="w-full bg-theme-blue text-white font-black py-4 rounded-2xl shadow-lg active:scale-95 transition-transform text-lg">ï¼‹ æ–°å¢æ•¸æ“šç´€éŒ„</button></div>
    </div>

    <!-- è³‡æ–™æ–°å¢/ç·¨è¼¯å½ˆçª— -->
    <div id="modalOverlay" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden items-end sm:items-center justify-center z-50">
        <div id="dataModal" class="bg-white w-full max-w-md rounded-t-[2.5rem] sm:rounded-[2.5rem] p-8 modal-animate max-h-[90vh] overflow-y-auto hidden">
            <div class="flex justify-between items-center mb-6">
                <h3 id="modalTitle" class="text-xl font-black text-slate-800">æ–°å¢æ•¸æ“š</h3>
                <button onclick="closeAllModals()" class="text-slate-400 text-2xl p-2">&times;</button>
            </div>
            <div class="space-y-4 text-left font-bold text-slate-800">
                <input type="hidden" id="editId">
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-[10px] font-bold text-slate-400 mb-1 ml-1 uppercase">åœ°å€</label><select id="fLocation" onchange="toggleFormFields()" class="w-full bg-slate-100 p-4 rounded-2xl font-bold text-slate-700"><option value="domestic">ğŸ  åœ‹å…§</option><option value="overseas">ğŸŒ åœ‹å¤–</option></select></div>
                    <div><label class="block text-[10px] font-bold text-slate-400 mb-1 ml-1 uppercase">é¡å‹</label><select id="fType" onchange="toggleFormFields()" class="w-full bg-slate-100 p-4 rounded-2xl font-bold text-slate-800">
                        <option value="buy">ğŸ”µ è²·å…¥ (å‚µåˆ¸)</option><option value="sell">ğŸ”´ è³£å‡º (å‚µåˆ¸)</option>
                        <option value="stock">ğŸ“ˆ è²·å…¥ (è‚¡ç¥¨)</option><option value="cash">ğŸ’µ ç¾é‡‘è³‡ç”¢</option>
                        <option value="div">ğŸ’° é…æ¯</option><option value="loan">ğŸ¦ è³ªæŠ¼å€Ÿæ¬¾</option>
                        <option value="credit_loan">ğŸ¦ ä¿¡è²¸å€Ÿæ¬¾</option><option value="interest_expense">â– åˆ©æ¯æ”¯å‡º</option>
                    </select></div>
                </div>
                <div id="stockFields" class="hidden"><label class="block text-[10px] font-bold text-indigo-500 mb-1 ml-1 uppercase">è‚¡ç¥¨ä»£è™Ÿ</label><input type="text" id="fSymbol" class="w-full bg-indigo-50 p-4 rounded-2xl font-bold text-indigo-700" placeholder="ä¾‹å¦‚ 2330"></div>
                <div class="grid grid-cols-2 gap-3 text-slate-800">
                    <div><label id="dateLabel" class="block text-[10px] font-bold text-slate-400 mb-1 ml-1 uppercase">æ—¥æœŸ</label><input type="date" id="fDate" class="w-full bg-slate-100 p-4 rounded-2xl font-bold text-slate-700"></div>
                    <div id="fEndDateGroup" class="hidden"><label class="block text-[10px] font-bold text-slate-400 mb-1 ml-1 uppercase">å„Ÿé‚„æ—¥</label><input type="date" id="fEndDate" class="w-full bg-slate-100 p-4 rounded-2xl font-bold text-slate-700"></div>
                    <div id="fAmountGroup"><label id="amountLabel" class="block text-[10px] font-bold text-slate-400 mb-1 ml-1 uppercase">å¼µæ•¸/è‚¡æ•¸</label><input type="number" id="fAmount" oninput="calcDivTotal()" class="w-full bg-slate-100 p-4 rounded-2xl font-bold text-slate-700" placeholder="0"></div>
                </div>
                <div id="fCreditGroup" class="hidden space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-[10px] font-bold text-slate-400 mb-1 ml-1 uppercase">ç¸½æœŸæ•¸</label><input type="number" id="fTotalTerm" class="w-full bg-slate-100 p-4 rounded-2xl"></div>
                        <div><label class="block text-[10px] font-bold text-slate-400 mb-1 ml-1 uppercase">æœˆé‚„æ—¥(è™Ÿ)</label><input type="number" id="fDueDay" class="w-full bg-slate-100 p-4 rounded-2xl" placeholder="15"></div>
                        <div class="col-span-2"><label class="block text-[10px] font-bold text-indigo-500 mb-1 ml-1 uppercase font-bold text-indigo-500">å‰©é¤˜æœŸæ•¸</label><input type="number" id="fRemainingTerm" class="w-full bg-indigo-50 p-4 rounded-2xl font-bold text-indigo-700"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-[10px] font-bold text-rose-500 mb-1 ml-1 uppercase italic">æœˆé‚„æ¬¾é¡</label><input type="number" id="fCustomEMI" class="w-full bg-rose-50 p-4 rounded-2xl font-bold text-rose-700 underline"></div>
                        <div><label class="block text-[10px] font-bold text-rose-500 mb-1 ml-1 uppercase italic">ç›®å‰é¤˜é¡</label><input type="number" id="fCustomBalance" class="w-full bg-rose-50 p-4 rounded-2xl font-bold text-rose-700 underline"></div>
                    </div>
                </div>
                <div id="fDivPerShareGroup" class="hidden"><label class="block text-[10px] font-bold text-indigo-500 mb-1 ml-1 uppercase font-bold text-indigo-500">æ¯è‚¡é…æ¯</label><input type="number" id="fDivPerShare" oninput="calcDivTotal()" step="0.0001" class="w-full bg-indigo-50 p-4 rounded-2xl font-bold text-indigo-700"></div>
                <div id="fCollateralGroup" class="hidden"><label class="block text-[10px] font-bold text-slate-400 mb-1 ml-1 uppercase">æ“”ä¿å¼µæ•¸</label><input type="number" id="fCollateral" class="w-full bg-slate-100 p-4 rounded-2xl font-bold text-slate-700"></div>
                <div><label id="priceLabel" class="block text-[10px] font-bold text-slate-400 mb-1 ml-1 uppercase">é‡‘é¡/å–®åƒ¹</label><input type="number" id="fPrice" class="w-full bg-slate-100 p-4 rounded-2xl text-lg font-bold text-slate-700"></div>
                <div id="fRateGroup" class="hidden"><label class="block text-[10px] font-bold text-slate-400 mb-1 ml-1 uppercase">å¹´åˆ©ç‡ (%)</label><input type="number" id="fRate" step="0.01" class="w-full bg-slate-100 p-4 rounded-2xl font-bold text-slate-700" placeholder="2.15"></div>
                <div><label class="block text-[10px] font-bold text-slate-400 mb-1 ml-1 uppercase">å‚™è¨»è¨»è§£</label><textarea id="fComment" class="w-full bg-slate-100 p-4 rounded-2xl text-sm font-medium h-20 text-slate-700"></textarea></div>
                <button onclick="saveData()" class="w-full bg-theme-blue text-white font-black py-5 rounded-2xl shadow-xl mt-4 text-lg">å„²å­˜ç´€éŒ„</button>
            </div>
        </div>

        <!-- è¨­å®š / Excel / å¸‚åƒ¹ Modals (ç•¥) -->
        <div id="settingsModal" class="bg-white w-full max-w-xs rounded-[2.5rem] p-8 shadow-2xl text-center hidden text-slate-800 font-bold"><h3 class="text-xl font-black mb-6">æ•¸æ“šç®¡ç†</h3><div class="space-y-3"><button onclick="openExcelModal()" class="w-full bg-indigo-50 text-indigo-700 font-bold py-4 rounded-2xl border border-indigo-100">Excel è²¼ä¸ŠåŒ¯å…¥</button><button onclick="exportData()" class="w-full bg-slate-50 text-slate-700 font-bold py-4 rounded-2xl border border-slate-100">åŒ¯å‡ºå‚™ä»½ (JSON)</button><button onclick="triggerImport()" class="w-full bg-emerald-50 text-emerald-700 font-bold py-4 rounded-2xl">åŒ¯å…¥æ›´æ–° (JSON)</button><button onclick="resetData()" class="w-full bg-rose-50 text-rose-700 font-bold py-4 rounded-2xl text-xs font-bold text-rose-700">æ¸…ç©ºè³‡æ–™</button><button onclick="closeAllModals()" class="w-full text-slate-400 pt-4 font-medium">é—œé–‰</button></div></div>
        <div id="excelModal" class="bg-white w-full max-w-md rounded-t-[2.5rem] sm:rounded-[2.5rem] p-8 modal-animate hidden text-center font-bold text-slate-800"><h3 class="text-xl font-black mb-2 text-center text-slate-800">Excel å¿«é€ŸåŒ¯å…¥</h3><textarea id="excelPasteArea" class="w-full bg-slate-100 p-4 rounded-2xl h-40 text-xs font-mono mb-4 border-none text-slate-700"></textarea><div class="flex gap-2"><button onclick="closeAllModals()" class="flex-1 bg-slate-100 text-slate-500 font-bold py-3 rounded-xl text-sm">å–æ¶ˆ</button><button onclick="processExcelImport()" class="flex-1 bg-theme-blue text-white font-bold py-3 rounded-xl text-sm text-white">åŸ·è¡ŒåŒ¯å…¥</button></div></div>
        <div id="priceModal" class="bg-white w-full max-w-xs rounded-[2rem] p-6 shadow-2xl text-center hidden font-bold text-slate-800"><h3 class="font-black mb-2 text-left ml-2 text-slate-800">æ›´æ–° 00720B å¸‚åƒ¹</h3><input type="number" id="mPriceInput" inputmode="decimal" step="0.01" class="w-full bg-slate-100 p-4 rounded-2xl mb-4 text-xl font-bold text-indigo-600"><div class="flex gap-2"><button onclick="closeAllModals()" class="flex-1 bg-slate-100 text-slate-500 font-bold py-3 rounded-xl text-sm text-slate-800">å–æ¶ˆ</button><button onclick="updateMarketPrice()" class="flex-1 bg-theme-blue text-white font-bold py-3 rounded-xl text-sm text-white">æ›´æ–°</button></div></div>
    </div>

    <input type="file" id="importFile" class="hidden" onchange="handleFileImport(event)" accept=".json">

    <script>
        const FINMIND_TOKEN = "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJkYXRlIjoiMjAyNi0wMi0wMyAxNzoxNDo0MSIsInVzZXJfaWQiOiJraGtoNjExOTIiLCJlbWFpbCI6Imtoa2g2MTE5MkBnbWFpbC5jb20iLCJpcCI6IjQ5LjIxNi4xNjIuMjQ3In0.D6XR5DxxwrIqlEyI1T4JUDMQSbnx-83uDoKSJZfAPqc";
        const DB_KEY = 'bond_v2026';
        const PRICE_KEY = 'current_market_price_v2026';
        let db = [];
        let marketPrice = 33.66;
        let stockPrices = {};
        let activeTab = 'records';

        window.onload = function() { loadData(); autoProcessCreditLoans(); fetchAllPrices(); renderUI(); };

        // --- å¼·æ•ˆè³‡æ–™åŠ è¼‰èˆ‡ä¿®å¾© ---
        function loadData() {
            try {
                const raw = localStorage.getItem(DB_KEY);
                db = raw ? JSON.parse(raw) : [];
                db = db.map(i => ({
                    id: i.id || Date.now() + Math.random(),
                    location: i.location || 'domestic',
                    type: i.type || 'buy',
                    date: i.date || new Date().toISOString().split('T')[0],
                    endDate: i.endDate || '',
                    amount: parseFloat(i.amount) || 0,
                    price: parseFloat(i.price) || 0,
                    rate: parseFloat(i.rate) || 0,
                    collateralAmount: parseFloat(i.collateralAmount) || 0,
                    remainingTerm: parseFloat(i.remainingTerm) || 0,
                    totalTerm: parseFloat(i.totalTerm) || 0,
                    dueDay: parseFloat(i.dueDay) || 0,
                    customEMI: parseFloat(i.customEMI) || 0,
                    customBalance: parseFloat(i.customBalance) || 0,
                    divPerShare: parseFloat(i.divPerShare) || 0,
                    symbol: i.symbol || '',
                    comment: i.comment || '',
                    lastProcessedMonth: i.lastProcessedMonth || ''
                }));
                const p = localStorage.getItem(PRICE_KEY);
                if (p) marketPrice = parseFloat(p);
            } catch(e) { db = []; }
        }

        async function fetchAllPrices() {
            const statusEl = document.getElementById('priceStatus');
            if (statusEl) statusEl.innerText = "(åŒæ­¥ä¸­...)";
            const dateStr = new Date(Date.now() - 864000000).toISOString().split('T')[0];
            try {
                const res = await fetch(`https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockPrice&data_id=00720B&start_date=${dateStr}&token=${FINMIND_TOKEN}`);
                const json = await res.json();
                if (json.msg === "success" && json.data.length > 0) {
                    marketPrice = parseFloat(json.data[json.data.length - 1].close);
                    localStorage.setItem(PRICE_KEY, marketPrice);
                }
            } catch (e) {}
            const symbols = [...new Set(db.filter(i => i.type === 'stock' && i.symbol).map(i => i.symbol))];
            for (let sym of symbols) {
                try {
                    const res = await fetch(`https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockPrice&data_id=${sym}&start_date=${dateStr}&token=${FINMIND_TOKEN}`);
                    const json = await res.json();
                    if (json.msg === "success" && json.data.length > 0) stockPrices[sym] = parseFloat(json.data[json.data.length - 1].close);
                } catch (e) {}
            }
            if (statusEl) statusEl.innerText = "(åŒæ­¥æˆåŠŸ)";
            renderUI();
        }

        function calcEMI(p, r, t) { if(t <= 0) return 0; const ir = r/12/100; if(ir===0) return p/t; return (p*ir*Math.pow(1+ir,t))/(Math.pow(1+ir,t)-1); }
        function calcBalance(p, r, t, rt) { if(rt <= 0) return 0; const emi = calcEMI(p,r,t); const ir = r/12/100; if(ir===0) return emi*rt; return (emi/ir)*(1-Math.pow(1+ir,-rt)); }
        function calcItemInterest(i, now) { if(!i.date || i.type !== 'loan') return 0; const s=new Date(i.date), eL=i.endDate?new Date(i.endDate):now; const d=Math.max(0, (Math.min(now,eL)-s)/86400000); return (i.price*(i.rate/100)*(d/365)); }

        function autoProcessCreditLoans() {
            const today = new Date(); const tag = `${today.getFullYear()}-${today.getMonth()+1}`;
            let changed = false;
            db.forEach(i => {
                if (i.type === 'credit_loan' && i.remainingTerm > 0 && today.getDate() >= i.dueDay && i.lastProcessedMonth !== tag) {
                    i.remainingTerm -= 1;
                    if (i.customBalance > 0) {
                        const emi = i.customEMI > 0 ? i.customEMI : calcEMI(i.price, i.rate, i.totalTerm);
                        i.customBalance -= (emi - (i.customBalance * i.rate / 1200));
                    }
                    i.lastProcessedMonth = tag; changed = true;
                }
            });
            if (changed) localStorage.setItem(DB_KEY, JSON.stringify(db));
        }

        // --- å®‰å…¨æ¸²æŸ“ ---
        function renderUI() {
            const now = new Date();
            let sumB=0, sumC=0, sumO=0, sumD=0, sumSI=0, sumUI=0, loanP=0, loanC=0, sumCB=0, sumSVal=0, sumCash=0;
            
            db.forEach(i => {
                const p = parseFloat(i.price) || 0, a = parseFloat(i.amount) || 0;
                if (i.type === 'stock') { sumSVal += a * (stockPrices[i.symbol] || p); }
                else if (i.type === 'cash') { sumCash += p; }
                else if (i.type === 'credit_loan') { sumCB += i.customBalance > 0 ? i.customBalance : calcBalance(p, i.rate, i.totalTerm, i.remainingTerm); }
                else {
                    if (i.location==='domestic') { if(i.type==='buy'){ sumB+=a; sumC+=(p*a*1000); } if(i.type==='sell'){ sumB-=a; sumC-=(p*a*1000); } }
                    else { if(i.type==='buy') sumO+=p; if(i.type==='sell') sumO-=p; }
                    if (i.type==='div') sumD+=p; if (i.type==='interest_expense') sumSI+=p;
                    if (i.type==='loan') { sumUI+=calcItemInterest(i, now); loanP+=p; loanC+=i.collateralAmount || 0; }
                }
            });

            const mkt = (sumB * marketPrice * 1000) + sumO;
            const totalAssets = mkt + sumSVal + sumCash - sumUI - loanP - sumCB;
            const pl = (mkt + sumSVal + sumCash - sumC) + sumD - (sumSI + sumUI);

            const safeSet = (id, val) => { const el = document.getElementById(id); if(el) el.innerText = val; };
            safeSet('totalBonds', sumB.toLocaleString());
            const plEl = document.getElementById('totalProfitLoss');
            if(plEl) { plEl.innerText = (pl>=0?'+':'')+'$'+Math.round(pl).toLocaleString(); plEl.style.color = pl>=0?'#3B7695':'#e11d48'; }
            safeSet('domesticPriceDisplay', '$'+marketPrice.toFixed(2));
            safeSet('totalStockValue', '$'+Math.round(sumSVal).toLocaleString());
            safeSet('totalCashValue', '$'+Math.round(sumCash).toLocaleString());
            safeSet('totalAvgPrice', '$'+(sumB>0?(sumC/(sumB*1000)).toFixed(2):'0.00'));
            safeSet('totalCreditBalance', '$'+Math.round(sumCB).toLocaleString());
            safeSet('totalPledgeAmt', '$'+Math.round(loanP).toLocaleString());
            safeSet('totalMaintenanceRatio', loanP>0 ? ((loanC*1000*marketPrice)/loanP*100).toFixed(1)+'%' : '0%');
            safeSet('totalDividends', '$'+Math.round(sumD).toLocaleString());
            safeSet('settledInterest', '-$'+Math.round(sumSI).toLocaleString());
            safeSet('unsettledInterest', '-$'+Math.round(sumUI).toLocaleString());
            safeSet('totalAssetsDisplay', '$'+Math.round(totalAssets).toLocaleString());
            safeSet('marketValue', '$'+Math.round(mkt + sumSVal + sumCash).toLocaleString());
            renderList();
        }

        function renderList() {
            const view = document.getElementById('mainContentView'); view.innerHTML = ''; const now = new Date();
            if (activeTab === 'reports' || activeTab === 'charts') { 
                view.innerHTML = '<p class="text-center py-10 text-slate-300">å ±è¡¨èˆ‡åœ–è¡¨æ•´ç†ä¸­...</p>'; 
                return; 
            }
            let filtered = [...db];
            if (activeTab==='pledge') filtered=filtered.filter(i=>i.type==='loan'||i.type==='interest_expense');
            else if (activeTab==='loan') filtered=filtered.filter(i=>i.type==='credit_loan');
            else if (activeTab==='stocks') filtered=filtered.filter(i=>i.type==='stock');
            else if (activeTab==='cash') filtered=filtered.filter(i=>i.type==='cash');
            else if (activeTab==='records') filtered=filtered.filter(i=>i.type==='buy'||i.type==='sell');
            else if (activeTab==='dividends') filtered=filtered.filter(i=>i.type==='div');
            else if (activeTab==='overseas') filtered=filtered.filter(i=>i.location==='overseas');
            
            filtered.sort((a,b)=>new Date(b.date)-new Date(a.date));
            if (filtered.length === 0) { view.innerHTML = '<p class="text-center py-10 text-slate-300">å°šç„¡ç´€éŒ„</p>'; return; }
            filtered.forEach(i => {
                const card = document.createElement('div');
                let isEx = (i.type==='loan'&&i.endDate && (new Date(i.endDate)-now)/86400000 <= 30);
                card.className = `p-5 rounded-[1.5rem] shadow-sm border mb-3 ${isEx?'bg-rose-50 border-rose-200':'bg-white border-slate-100'}`;
                let det = '';
                if(i.type==='stock') det = `<p class="text-xs font-bold text-indigo-600">å¸‚å€¼: $${Math.round(i.amount*(stockPrices[i.symbol]||i.price)).toLocaleString()}</p><p class="text-[10px]">ä»£è™Ÿ: ${i.symbol} | è‚¡æ•¸: ${i.amount.toLocaleString()} | ç¾åƒ¹: $${stockPrices[i.symbol]||i.price}</p>`;
                else if(i.type==='cash') det = `<div class="text-xs text-emerald-600 font-bold">ç¾é‡‘è³‡ç”¢: $${i.price.toLocaleString()}</div>`;
                else if(i.type==='credit_loan') det = `<p class="text-rose-500 font-bold text-right text-sm">é¤˜é¡: $${Math.round(i.customBalance > 0 ? i.customBalance : calcBalance(i.price,i.rate,i.totalTerm,i.remainingTerm)).toLocaleString()}</p><p class="text-[10px]">å‰©é¤˜: ${i.remainingTerm}/${i.totalTerm}</p>`;
                else if(i.type==='loan') det = `<p class="text-indigo-600 font-bold text-right font-black text-sm">åˆ©æ¯: $${Math.round(calcItemInterest(i,now)).toLocaleString()}</p><p class="text-[10px]">æœ¬é‡‘: $${i.price.toLocaleString()} (@${i.rate}%)</p>`;
                else det = `<div class="text-xs text-slate-600">${(i.type==='div'&&i.divPerShare>0)?i.amount+'å¼µ Ã— 1000è‚¡ Ã— '+i.divPerShare : (i.amount>0?i.amount+'å¼µ / $'+i.price : 'ç¸½é¡: $'+i.price.toLocaleString())}</div>`;
                card.innerHTML = `<div class="flex justify-between items-start mb-1 text-slate-800 text-sm"><div><span class="font-bold ${i.type==='buy'||i.type==='stock'||i.type==='cash'?'text-emerald-600':'text-indigo-600'}">${getLabel(i.type)}</span><div class="text-[10px] text-slate-400 font-bold">${i.type==='loan'?i.date+' ~ '+(i.endDate||'é€²è¡Œä¸­'):i.date}</div></div><div class="flex gap-4"><button onclick="editData('${i.id}')" class="text-indigo-600 text-xs font-bold">ç·¨è¼¯</button><button onclick="deleteData('${i.id}')" class="text-rose-400 text-xs font-bold">åˆªé™¤</button></div></div><div class="bg-slate-50 p-3 rounded-xl mt-2 text-slate-800">${det}${i.comment?`<div class="text-[11px] text-indigo-500 font-bold mt-2 border-t border-slate-200 pt-2 italic text-right"># ${i.comment}</div>`:''}</div>`;
                view.appendChild(card);
            });
        }

        // --- è¡¨å–®é‚è¼¯ ---
        function toggleFormFields() {
            const t = document.getElementById('fType').value, loc = document.getElementById('fLocation').value;
            const isC=(t==='credit_loan'), isS=(t==='stock'), isCash=(t==='cash');
            document.getElementById('stockFields').classList.toggle('hidden', !isS);
            document.getElementById('fCreditGroup').classList.toggle('hidden', !isC);
            document.getElementById('fRateGroup').classList.toggle('hidden', t!=='loan' && !isC);
            document.getElementById('fEndDateGroup').classList.toggle('hidden', t!=='loan');
            document.getElementById('fCollateralGroup').classList.toggle('hidden', t!=='loan');
            document.getElementById('fDivPerShareGroup').classList.toggle('hidden', t!=='div');
            document.getElementById('fAmountGroup').classList.toggle('hidden', isC || t==='loan' || isCash);
            document.getElementById('amountLabel').innerText = isS ? 'è²·å…¥è‚¡æ•¸' : (t==='div'?'é…æ¯å¼µæ•¸':'å¼µæ•¸');
            document.getElementById('dateLabel').innerText = isC ? 'ç”³è²¸æ—¥æœŸ' : (t === 'loan' ? 'èµ·æ¯æ—¥' : 'æ—¥æœŸ');
            document.getElementById('priceLabel').innerText = isC ? 'è²¸æ¬¾ç¸½é¡' : (t==='loan'?'è³ªæŠ¼æœ¬é‡‘':(isCash?'ç¾é‡‘é‡‘é¡':(isS?'è²·å…¥å–®åƒ¹':'é‡‘é¡/å–®åƒ¹')));
        }

        function saveData() {
            const id = document.getElementById('editId').value;
            const item = { id: id || Date.now() + Math.random(), location: document.getElementById('fLocation').value, type: document.getElementById('fType').value, date: document.getElementById('fDate').value, endDate: document.getElementById('fEndDate').value, amount: parseFloat(document.getElementById('fAmount').value)||0, price: parseFloat(document.getElementById('fPrice').value)||0, rate: parseFloat(document.getElementById('fRate').value)||0, totalTerm: parseFloat(document.getElementById('fTotalTerm').value)||0, remainingTerm: parseFloat(document.getElementById('fRemainingTerm').value)||0, dueDay: parseFloat(document.getElementById('fDueDay').value)||0, customEMI: parseFloat(document.getElementById('fCustomEMI').value)||0, customBalance: parseFloat(document.getElementById('fCustomBalance').value)||0, comment: document.getElementById('fComment').value||'', divPerShare: parseFloat(document.getElementById('fDivPerShare').value)||0, collateralAmount: parseFloat(document.getElementById('fCollateral').value)||0, symbol: document.getElementById('fSymbol').value };
            localStorage.setItem(DB_KEY, JSON.stringify(id ? db.map(r=>r.id==id?item:r) : [...db, item])); closeAllModals(); loadData(); renderUI();
        }

        function editData(id) {
            const r=db.find(i=>i.id == id); if (!r) return; openModal();
            document.getElementById('editId').value=r.id; document.getElementById('fLocation').value=r.location; document.getElementById('fType').value=r.type; document.getElementById('fDate').value=r.date; document.getElementById('fPrice').value=r.price; document.getElementById('fRate').value=r.rate; document.getElementById('fTotalTerm').value=r.totalTerm||''; document.getElementById('fRemainingTerm').value=r.remainingTerm||''; document.getElementById('fDueDay').value=r.dueDay||''; document.getElementById('fCustomEMI').value=r.customEMI||''; document.getElementById('fCustomBalance').value=r.customBalance||''; document.getElementById('fComment').value=r.comment; document.getElementById('fAmount').value=r.amount; document.getElementById('fDivPerShare').value=r.divPerShare; document.getElementById('fCollateral').value=r.collateralAmount; document.getElementById('fSymbol').value=r.symbol||''; toggleFormFields();
        }

        // --- åŸºæœ¬åŠŸèƒ½ ---
        function switchTab(t) { activeTab = t; document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.id === 'tab-'+t)); renderUI(); }
        function closeAllModals() { document.getElementById('modalOverlay').classList.add('hidden'); ['dataModal','settingsModal','priceModal','excelModal'].forEach(m=>document.getElementById(m).classList.add('hidden')); }
        function openModal() { closeAllModals(); document.getElementById('modalOverlay').classList.replace('hidden','flex'); document.getElementById('dataModal').classList.remove('hidden'); document.getElementById('editId').value=''; toggleFormFields(); }
        function openSettingsModal() { closeAllModals(); document.getElementById('modalOverlay').classList.replace('hidden','flex'); document.getElementById('settingsModal').classList.remove('hidden'); }
        function openPriceModal() { closeAllModals(); document.getElementById('modalOverlay').classList.replace('hidden','flex'); document.getElementById('priceModal').classList.remove('hidden'); document.getElementById('mPriceInput').value = marketPrice; }
        function openExcelModal() { closeAllModals(); document.getElementById('modalOverlay').classList.replace('hidden','flex'); document.getElementById('excelModal').classList.remove('hidden'); }
        function updateMarketPrice() { const v = parseFloat(document.getElementById('mPriceInput').value); if(v>0){ marketPrice=v; localStorage.setItem(PRICE_KEY, v); closeAllModals(); renderUI(); } }
        function deleteData(id) { if(confirm('åˆªé™¤ï¼Ÿ')){ db=db.filter(i=>i.id!=id); localStorage.setItem(DB_KEY, JSON.stringify(db)); renderUI(); } }
        function resetData() { if(confirm('é‡è¨­ï¼Ÿ')){ localStorage.clear(); location.reload(); } }
        function calcDivTotal() { const t=document.getElementById('fType').value; if(t==='div'){ const s=parseFloat(document.getElementById('fAmount').value)||0,p=parseFloat(document.getElementById('fDivPerShare').value)||0; if(s>0&&p>0) document.getElementById('fPrice').value=Math.round(s*1000*p); } }
        function getLabel(t) { return {buy:'ğŸ”µ è²·å…¥', sell:'ğŸ”´ è³£å‡º', div:'ğŸ’° é…æ¯', loan:'ğŸ¦ è³ªæŠ¼', credit_loan:'ğŸ¦ ä¿¡è²¸', interest_expense:'â– åˆ©æ¯', stock:'ğŸ“ˆ è‚¡ç¥¨', cash:'ğŸ’µ ç¾é‡‘'}[t] || t; }
        function exportData() { const blob = new Blob([JSON.stringify(db)], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `backup_${new Date().toISOString().split('T')[0]}.json`; a.click(); }
        function triggerImport() { document.getElementById('importFile').click(); }
        function handleFileImport(e) { const f = e.target.files[0]; if (!f) return; const reader = new FileReader(); reader.onload=(ev)=>{ try{ db=JSON.parse(ev.target.result); localStorage.setItem(DB_KEY,JSON.stringify(db)); location.reload(); }catch(e){alert('æ ¼å¼éŒ¯èª¤');}}; reader.readAsText(f); }
        function processExcelImport() { /* ç¶­æŒåŸæœ‰é‚è¼¯... */ }
    </script>
</body>
</html>