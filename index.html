<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å‚µåˆ¸è³ªæŠ¼èˆ‡ä¿¡è²¸ç®¡ç† V2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        html { -webkit-text-size-adjust: 100%; height: 100%; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; -webkit-tap-highlight-color: transparent; min-height: 100vh; background-color: #f8fafc; margin: 0; }
        .safe-area-top { padding-top: env(safe-area-inset-top); }
        .safe-area-bottom { padding-bottom: calc(env(safe-area-inset-bottom) + 1rem); }
        .bg-theme-blue { background-color: #3B7695; }
        .tab-btn { padding: 0.6rem 0.2rem; font-size: 0.8rem; font-weight: 500; border-radius: 0.75rem; transition: all 0.2s; flex: 1; text-align: center; color: #64748b; }
        .tab-btn.active { background-color: #3B7695; color: white !important; font-weight: 700; box-shadow: 0 4px 10px -2px rgb(59 118 149 / 0.4); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        input, select, textarea { -webkit-appearance: none; appearance: none; border: none; outline: none; }
        @keyframes modalIn { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .modal-animate { animation: modalIn 0.3s ease-out; }
    </style>
</head>
<body class="text-slate-800 pb-32">

    <!-- Header -->
    <nav class="bg-theme-blue text-white shadow-lg sticky top-0 z-30 safe-area-top">
        <div class="max-w-md mx-auto p-4 flex justify-between items-center">
            <h1 class="font-bold text-lg tracking-tight">è³‡ç”¢è³ªæŠ¼èˆ‡ä¿¡è²¸ (V2026)</h1>
            <div class="flex items-center space-x-2">
                <button onclick="exportData()" class="text-[11px] bg-white/20 px-3 py-1.5 rounded-full font-medium">å‚™ä»½</button>
                <button onclick="triggerImport()" class="text-[11px] bg-white/20 px-2 py-1.5 rounded-full font-medium">æ›´æ–°</button>
                <button onclick="openSettingsModal()" class="text-[11px] bg-white/20 px-2 py-1.5 rounded-full font-medium">è¨­å®š</button>
            </div>
        </div>
    </nav>

    <div class="max-w-md mx-auto p-4 space-y-4">
        <!-- ç¸½è¦½å¡ç‰‡ -->
        <div class="bg-white rounded-[2.5rem] p-7 shadow-sm border border-slate-100 text-slate-800">
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div><p class="text-xs text-slate-400 mb-1 font-bold text-left uppercase">åœ‹å…§æŒå€‰ (å¼µ)</p><h2 id="totalBonds" class="text-2xl font-black text-indigo-600 truncate">0</h2></div>
                <div class="text-right"><p class="text-xs text-slate-400 mb-1 font-bold text-left uppercase">ç¸½é ä¼°æç›Š</p><h2 id="totalProfitLoss" class="text-xl font-black break-all leading-none">$0</h2></div>
            </div>
            <div class="space-y-3 pt-5 border-t border-slate-100 text-sm text-slate-600 font-medium">
                <div class="flex justify-between"><span>00720B ç›®å‰å¸‚åƒ¹</span><span id="domesticPriceDisplay" onclick="openPriceModal()" class="font-bold text-indigo-600 underline decoration-dotted cursor-pointer">$0.00</span></div>
                <div class="flex justify-between"><span>ç¸½å¹³å‡åƒ¹ä½</span><span id="totalAvgPrice" class="font-bold text-slate-700">$0.00</span></div>
                <div class="flex justify-between text-rose-500 font-bold"><span>ä¿¡è²¸ç¸½é¤˜é¡</span><span id="totalCreditBalance">$0</span></div>
                <div class="flex justify-between"><span>è³ªæŠ¼ç¸½é‡‘é¡</span><span id="totalPledgeAmt" class="font-bold text-slate-700">$0</span></div>
                <div class="flex justify-between"><span>è³ªæŠ¼ç¸½ç¶­æŒç‡</span><span id="totalMaintenanceRatio" class="font-bold text-indigo-700">0%</span></div>
                <div class="flex justify-between text-emerald-600"><span>ç´¯è¨ˆé…æ¯æ”¶å…¥</span><span id="totalDividends">$0</span></div>
                <div class="flex justify-between text-rose-600"><span>æœªçµç®—è³ªæŠ¼åˆ©æ¯</span><span id="unsettledInterest">-$0</span></div>
                <div class="flex justify-between pt-2 border-t font-bold text-slate-700 bg-slate-50 p-2 rounded-lg">
                    <span>ç¸½è³‡ç”¢ (æ·¨å€¼)</span>
                    <span id="totalAssetsDisplay">$0</span>
                </div>
                <div class="flex justify-between font-bold text-indigo-700 text-base px-2"><span>ç›®å‰ç¸½å¸‚å€¼</span><span id="marketValue">$0</span></div>
            </div>
        </div>

        <!-- Tab å°è¦½ -->
        <div class="sticky top-[75px] z-20 bg-slate-50/80 backdrop-blur-md py-2">
            <div class="flex bg-white p-1.5 rounded-2xl shadow-sm border border-slate-100 overflow-x-auto no-scrollbar">
                <button onclick="switchTab('records')" id="tab-records" class="tab-btn active">äº¤æ˜“</button>
                <button onclick="switchTab('dividends')" id="tab-dividends" class="tab-btn">é…æ¯</button>
                <button onclick="switchTab('interest')" id="tab-interest" class="tab-btn">åˆ©æ¯/ä¿¡è²¸</button>
                <button onclick="switchTab('overseas')" id="tab-overseas" class="tab-btn">åœ‹å¤–</button>
                <button onclick="switchTab('reports')" id="tab-reports" class="tab-btn">å ±è¡¨</button>
                <button onclick="switchTab('charts')" id="tab-charts" class="tab-btn">åœ–è¡¨</button>
            </div>
        </div>
        <div id="mainContentView" class="space-y-3 min-h-[300px]"></div>
    </div>

    <!-- åº•éƒ¨æŒ‰éˆ• -->
    <div class="fixed bottom-0 left-0 right-0 p-4 bg-white/80 backdrop-blur-xl border-t border-slate-100 z-40 safe-area-bottom text-center">
        <div class="max-w-md mx-auto"><button onclick="openModal()" class="w-full bg-theme-blue text-white font-bold py-4 rounded-2xl shadow-lg active:scale-95 transition-transform text-lg">ï¼‹ æ–°å¢æ•¸æ“šç´€éŒ„</button></div>
    </div>

    <!-- Modal å®¹å™¨ -->
    <div id="modalOverlay" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden items-end sm:items-center justify-center z-50">
        <div id="dataModal" class="bg-white w-full max-w-md rounded-t-[2.5rem] sm:rounded-[2.5rem] p-8 modal-animate max-h-[90vh] overflow-y-auto hidden">
            <div class="flex justify-between items-center mb-6 text-slate-800">
                <h3 id="modalTitle" class="text-xl font-black">æ–°å¢æ•¸æ“š</h3>
                <button onclick="closeAllModals()" class="text-slate-400 text-2xl p-2">&times;</button>
            </div>
            <div class="space-y-4 text-left">
                <input type="hidden" id="editId">
                <div class="grid grid-cols-2 gap-3 text-slate-800">
                    <div><label class="block text-[10px] font-bold text-slate-400 mb-1 ml-1 uppercase">åœ°å€</label><select id="fLocation" onchange="toggleFormFields()" class="w-full bg-slate-100 p-4 rounded-2xl font-medium text-slate-700"><option value="domestic">ğŸ  åœ‹å…§</option><option value="overseas">ğŸŒ åœ‹å¤–</option></select></div>
                    <div><label class="block text-[10px] font-bold text-slate-400 mb-1 ml-1 uppercase">é¡å‹</label><select id="fType" onchange="toggleFormFields()" class="w-full bg-slate-100 p-4 rounded-2xl font-medium text-slate-700">
                        <option value="buy">ğŸ”µ è²·å…¥</option>
                        <option value="sell">ğŸ”´ è³£å‡º</option>
                        <option value="div">ğŸ’° é…æ¯</option>
                        <option value="loan">ğŸ¦ è³ªæŠ¼</option>
                        <option value="credit_loan">ğŸ¦ ä¿¡è²¸</option>
                        <option value="interest_expense">â– åˆ©æ¯æ”¯å‡º</option>
                    </select></div>
                </div>
                <div class="grid grid-cols-2 gap-3 text-slate-800">
                    <div><label id="dateLabel" class="block text-[10px] font-bold text-slate-400 mb-1 ml-1 uppercase">æ—¥æœŸ</label><input type="date" id="fDate" class="w-full bg-slate-100 p-4 rounded-2xl font-bold text-slate-700"></div>
                    <div id="fEndDateGroup"><label class="block text-[10px] font-bold text-slate-400 mb-1 ml-1 uppercase">å„Ÿé‚„æ—¥</label><input type="date" id="fEndDate" class="w-full bg-slate-100 p-4 rounded-2xl font-bold text-slate-700"></div>
                    <div id="fAmountGroup"><label id="amountLabel" class="block text-[10px] font-bold text-slate-400 mb-1 ml-1 uppercase text-slate-400">å¼µæ•¸</label><input type="number" id="fAmount" oninput="calcDivTotal()" inputmode="decimal" class="w-full bg-slate-100 p-4 rounded-2xl font-bold text-slate-700" placeholder="0"></div>
                </div>

                <!-- ä¿¡è²¸æ“´å……æ¬„ä½ -->
                <div id="fCreditGroup" class="hidden space-y-4">
                    <div class="grid grid-cols-2 gap-3 text-slate-800">
                        <div><label class="block text-[10px] font-bold text-slate-400 mb-1 ml-1 uppercase">è²¸æ¬¾ç¸½æœŸæ•¸</label><input type="number" id="fTotalTerm" inputmode="numeric" class="w-full bg-slate-100 p-4 rounded-2xl font-bold" placeholder="ä¾‹å¦‚ 84"></div>
                        <div><label class="block text-[10px] font-bold text-slate-400 mb-1 ml-1 uppercase">æ¯æœˆé‚„æ¬¾æ—¥</label><input type="number" id="fDueDay" inputmode="numeric" class="w-full bg-slate-100 p-4 rounded-2xl font-bold" placeholder="15"></div>
                        <div><label class="block text-[10px] font-bold text-indigo-500 mb-1 ml-1 uppercase">å‰©é¤˜é‚„æ¬¾æœŸæ•¸</label><input type="number" id="fRemainingTerm" inputmode="numeric" class="w-full bg-indigo-50 p-4 rounded-2xl font-bold text-indigo-700" placeholder="ä¾‹å¦‚ 42"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-[10px] font-bold text-rose-500 mb-1 ml-1 uppercase italic">æ¯æœˆé‚„æ¬¾é¡ (ä¿®æ­£ç”¨)</label><input type="number" id="fCustomEMI" inputmode="decimal" class="w-full bg-rose-50 p-4 rounded-2xl font-bold text-rose-700 underline" placeholder="éŠ€è¡ŒAppé¡¯ç¤ºé‡‘é¡"></div>
                        <div><label class="block text-[10px] font-bold text-rose-500 mb-1 ml-1 uppercase italic">ç•¶å‰è²¸æ¬¾é¤˜é¡ (ä¿®æ­£ç”¨)</label><input type="number" id="fCustomBalance" inputmode="decimal" class="w-full bg-rose-50 p-4 rounded-2xl font-bold text-rose-700 underline" placeholder="éŠ€è¡ŒAppé¡¯ç¤ºé¤˜é¡"></div>
                    </div>
                </div>

                <div id="fDivPerShareGroup" class="hidden text-slate-800">
                    <label class="block text-[10px] font-bold text-indigo-500 mb-1 ml-1 uppercase">æ¯è‚¡é…æ¯ (1å¼µ=1000è‚¡)</label>
                    <input type="number" id="fDivPerShare" oninput="calcDivTotal()" step="0.0001" inputmode="decimal" class="w-full bg-indigo-50 p-4 rounded-2xl text-indigo-700 font-bold" placeholder="ä¾‹å¦‚ 0.54">
                </div>
                <div id="fCollateralGroup" class="hidden text-slate-800"><label class="block text-[10px] font-bold text-slate-400 mb-1 ml-1 uppercase">æ“”ä¿å¼µæ•¸</label><input type="number" id="fCollateral" inputmode="decimal" class="w-full bg-slate-100 p-4 rounded-2xl font-bold text-slate-700" placeholder="0"></div>
                <div><label id="priceLabel" class="block text-[10px] font-bold text-slate-400 mb-1 ml-1 uppercase text-slate-400">é‡‘é¡/å–®åƒ¹</label><input type="number" id="fPrice" inputmode="decimal" class="w-full bg-slate-100 p-4 rounded-2xl text-lg font-bold text-slate-700" placeholder="0"></div>
                <div id="fRateGroup" class="hidden text-slate-800"><label class="block text-[10px] font-bold text-slate-400 mb-1 ml-1 uppercase">å¹´åˆ©ç‡ (%)</label><input type="number" id="fRate" step="0.01" inputmode="decimal" class="w-full bg-slate-100 p-4 rounded-2xl font-bold text-slate-700" placeholder="2.15"></div>
                <div><label class="block text-[10px] font-bold text-slate-400 mb-1 ml-1 uppercase text-slate-400">å‚™è¨»è¨»è§£</label><textarea id="fComment" class="w-full bg-slate-100 p-4 rounded-2xl text-sm font-medium h-20 text-slate-700" placeholder="åœ¨æ­¤è¼¸å…¥è¨»è§£..."></textarea></div>
                <button onclick="saveData()" class="w-full bg-theme-blue text-white font-black py-5 rounded-2xl shadow-xl mt-4 text-lg">å„²å­˜ç´€éŒ„</button>
            </div>
        </div>

        <!-- Settings / Excel / Price Modals (ç•¥...) -->
        <div id="settingsModal" class="bg-white w-full max-w-xs rounded-[2.5rem] p-8 shadow-2xl text-center hidden text-slate-800"><h3 class="text-xl font-black mb-6 text-slate-800">æ•¸æ“šç®¡ç†</h3><div class="space-y-3"><button onclick="openExcelModal()" class="w-full bg-indigo-50 text-indigo-700 font-bold py-4 rounded-2xl border border-indigo-100">Excel è²¼ä¸ŠåŒ¯å…¥</button><button onclick="exportData()" class="w-full bg-slate-50 text-slate-700 font-bold py-4 rounded-2xl border border-slate-100 text-sm">åŒ¯å‡ºå‚™ä»½ (JSON)</button><button onclick="triggerImport()" class="w-full bg-emerald-50 text-emerald-700 font-bold py-4 rounded-2xl text-sm">åŒ¯å…¥æ›´æ–° (JSON)</button><button onclick="resetData()" class="w-full bg-rose-50 text-rose-700 font-bold py-4 rounded-2xl text-xs font-bold">æ¸…ç©ºè³‡æ–™</button><button onclick="closeAllModals()" class="w-full text-slate-400 pt-4 font-medium text-sm">é—œé–‰</button></div></div>
        <div id="excelModal" class="bg-white w-full max-w-md rounded-t-[2.5rem] sm:rounded-[2.5rem] p-8 modal-animate hidden text-center text-slate-800"><h3 class="text-xl font-black mb-2 text-slate-800">Excel å¿«é€ŸåŒ¯å…¥</h3><textarea id="excelPasteArea" class="w-full bg-slate-100 p-4 rounded-2xl h-40 text-xs font-mono mb-4 border-none text-slate-700" placeholder="è²¼ä¸Šæ—¥æœŸã€å¼µæ•¸ã€åƒ¹ä½..."></textarea><div class="flex gap-2"><button onclick="closeAllModals()" class="flex-1 bg-slate-100 text-slate-500 font-bold py-3 rounded-xl text-sm">å–æ¶ˆ</button><button onclick="processExcelImport()" class="flex-1 bg-theme-blue text-white font-bold py-3 rounded-xl text-sm text-white">åŸ·è¡ŒåŒ¯å…¥</button></div></div>
        <div id="priceModal" class="bg-white w-full max-w-xs rounded-[2rem] p-6 shadow-2xl text-center hidden text-slate-800"><h3 class="font-black mb-2 text-left ml-2 text-slate-800">æ›´æ–°å¸‚åƒ¹</h3><input type="number" id="mPriceInput" inputmode="decimal" step="0.01" class="w-full bg-slate-100 p-4 rounded-2xl mb-4 text-xl font-bold text-indigo-600"><div class="flex gap-2"><button onclick="closeAllModals()" class="flex-1 bg-slate-100 text-slate-500 font-bold py-3 rounded-xl text-sm">å–æ¶ˆ</button><button onclick="updateMarketPrice()" class="flex-1 bg-theme-blue text-white font-bold py-3 rounded-xl text-sm text-white">æ›´æ–°</button></div></div>
    </div>

    <input type="file" id="importFile" class="hidden" onchange="handleFileImport(event)" accept=".json">

    <script>
        const DB_KEY = 'bond_v2026';
        const PRICE_KEY = 'current_market_price_v2026';
        let db = [];
        let marketPrice = 33.66;
        let activeTab = 'records';
        let mainChart = null;

        window.onload = function() { loadAllData(); autoProcessCreditLoans(); renderUI(); };

        function loadAllData() {
            try {
                const raw = localStorage.getItem(DB_KEY);
                db = raw ? JSON.parse(raw) : [];
                db = db.map(i => ({
                    id: i.id || Date.now() + Math.random(),
                    location: i.location || 'domestic',
                    type: i.type || 'buy',
                    date: i.date || new Date().toISOString().split('T')[0],
                    endDate: i.endDate || '',
                    amount: parseFloat(i.amount) || 0,
                    price: parseFloat(i.price) || 0,
                    rate: parseFloat(i.rate) || 0,
                    collateralAmount: parseFloat(i.collateralAmount) || 0,
                    totalTerm: parseFloat(i.totalTerm) || 0,
                    remainingTerm: parseFloat(i.remainingTerm) || 0,
                    dueDay: parseFloat(i.dueDay) || 0,
                    customEMI: parseFloat(i.customEMI) || 0,
                    customBalance: parseFloat(i.customBalance) || 0,
                    comment: i.comment || '',
                    divPerShare: parseFloat(i.divPerShare) || 0,
                    lastProcessedMonth: i.lastProcessedMonth || ''
                }));
                const p = localStorage.getItem(PRICE_KEY);
                if (p) marketPrice = parseFloat(p);
            } catch(e) { db = []; }
        }

        // --- ä¿¡è²¸é‚è¼¯ ---
        function autoProcessCreditLoans() {
            const today = new Date();
            const currentTag = `${today.getFullYear()}-${today.getMonth() + 1}`;
            let changed = false;
            db.forEach(i => {
                if (i.type === 'credit_loan' && i.remainingTerm > 0) {
                    if (today.getDate() >= i.dueDay && i.lastProcessedMonth !== currentTag) {
                        i.remainingTerm -= 1;
                        // å¦‚æœæœ‰æ‰‹å‹•è¼¸å…¥ç•¶å‰é¤˜é¡ï¼Œè‡ªå‹•æ‰£é™¤ä¸€æœŸæœ¬é‡‘ä¼°å€¼ (ç°¡åŒ–ï¼šè‹¥ç„¡æ‰‹å‹• EMI å‰‡ç”¨å…¬å¼)
                        if (i.customBalance > 0) {
                            const emi = i.customEMI > 0 ? i.customEMI : calcEMI(i.price, i.rate, i.totalTerm);
                            const monthlyInterest = (i.customBalance * (i.rate / 100)) / 12;
                            i.customBalance -= (emi - monthlyInterest);
                        }
                        i.lastProcessedMonth = currentTag;
                        changed = true;
                    }
                }
            });
            if (changed) localStorage.setItem(DB_KEY, JSON.stringify(db));
        }

        function calcEMI(principal, annualRate, totalTerm) {
            if (totalTerm <= 0) return 0;
            const r = annualRate / 12 / 100;
            if (r === 0) return principal / totalTerm;
            return (principal * r * Math.pow(1 + r, totalTerm)) / (Math.pow(1 + r, totalTerm) - 1);
        }

        function calcCreditBalance(principal, annualRate, totalTerm, remainingTerm) {
            if (remainingTerm <= 0) return 0;
            const emi = calcEMI(principal, annualRate, totalTerm);
            const r = annualRate / 12 / 100;
            if (r === 0) return emi * remainingTerm;
            return (emi / r) * (1 - Math.pow(1 + r, -remainingTerm));
        }

        // --- æ ¸å¿ƒè¨ˆç®—èˆ‡æ¸²æŸ“ ---
        function renderUI() {
            try {
                const now = new Date();
                let sumBonds = 0, sumCost = 0, sumOverseas = 0, sumDiv = 0, sumSettledInt = 0, sumUnsettledInt = 0, loanP = 0, loanC = 0, sumCreditBal = 0;
                
                db.forEach(i => {
                    const p = parseFloat(i.price) || 0, a = parseFloat(i.amount) || 0;
                    if (i.type === 'credit_loan') {
                        // å„ªå…ˆä½¿ç”¨æ‰‹å‹•è¼¸å…¥çš„é¤˜é¡
                        sumCreditBal += i.customBalance > 0 ? i.customBalance : calcCreditBalance(p, i.rate, i.totalTerm, i.remainingTerm);
                    } else {
                        if (i.location === 'domestic') {
                            if (i.type === 'buy') { sumBonds += a; sumCost += (p * a * 1000); }
                            if (i.type === 'sell') { sumBonds -= a; sumCost -= (p * a * 1000); }
                        } else {
                            if (i.type === 'buy') sumOverseas += p;
                            if (i.type === 'sell') sumOverseas -= p;
                        }
                        if (i.type === 'div') sumDiv += p;
                        if (i.type === 'interest_expense') sumSettledInt += p;
                        if (i.type === 'loan') {
                            sumUnsettledInt += calcItemInterest(i, now);
                            loanP += p;
                            loanC += parseFloat(i.collateralAmount) || 0;
                        }
                    }
                });

                const mktVal = (sumBonds * marketPrice * 1000) + sumOverseas;
                const totalInt = sumSettledInt + sumUnsettledInt;
                const pl = (mktVal - sumCost) + sumDiv - totalInt;
                const totalRatio = loanP > 0 ? ((loanC * 1000 * marketPrice) / loanP * 100) : 0;
                const avgPrice = sumBonds > 0 ? (sumCost / (sumBonds * 1000)) : 0;
                const totalAssets = mktVal - sumUnsettledInt - loanP - sumCreditBal;

                document.getElementById('totalBonds').innerText = sumBonds.toLocaleString();
                const plEl = document.getElementById('totalProfitLoss');
                plEl.innerText = (pl >= 0 ? '+' : '') + '$' + Math.round(pl).toLocaleString();
                plEl.style.color = pl >= 0 ? '#3B7695' : '#e11d48';

                document.getElementById('domesticPriceDisplay').innerText = '$' + marketPrice.toFixed(2);
                document.getElementById('totalAvgPrice').innerText = '$' + avgPrice.toFixed(2);
                document.getElementById('totalCreditBalance').innerText = '$' + Math.round(sumCreditBal).toLocaleString();
                document.getElementById('totalPledgeAmt').innerText = '$' + Math.round(loanP).toLocaleString();
                document.getElementById('totalMaintenanceRatio').innerText = totalRatio > 0 ? totalRatio.toFixed(1) + '%' : '0%';
                document.getElementById('totalDividends').innerText = '$' + Math.round(sumDiv).toLocaleString();
                document.getElementById('unsettledInterest').innerText = '-$' + Math.round(sumUnsettledInt).toLocaleString();
                document.getElementById('totalAssetsDisplay').innerText = '$' + Math.round(totalAssets).toLocaleString();
                document.getElementById('marketValue').innerText = '$' + Math.round(mktVal).toLocaleString();
                
                renderList();
            } catch(e) { console.error("Render fail", e); }
        }

        function renderList() {
            const view = document.getElementById('mainContentView'); view.innerHTML = ''; const now = new Date();
            if (activeTab === 'reports') { renderReports(view, now); return; }
            if (activeTab === 'charts') { renderCharts(view); return; }

            let filtered = [...db];
            if (activeTab === 'interest') {
                filtered = filtered.filter(i => i.type === 'loan' || i.type === 'interest_expense' || i.type === 'credit_loan');
                filtered.sort((a, b) => (a.endDate ? new Date(a.endDate) : new Date('2099-12-31')) - (b.endDate ? new Date(b.endDate) : new Date('2099-12-31')));
            } else {
                filtered.sort((a,b) => new Date(b.date) - new Date(a.date));
                if (activeTab === 'records') filtered = filtered.filter(i => i.type === 'buy' || i.type === 'sell');
                else if (activeTab === 'dividends') filtered = filtered.filter(i => i.type === 'div');
                else if (activeTab === 'overseas') filtered = filtered.filter(i => i.location === 'overseas');
            }

            if (filtered.length === 0) { view.innerHTML = '<div class="text-center py-10 text-slate-300 text-sm font-medium">å°šç„¡æ•¸æ“šç´€éŒ„</div>'; return; }

            filtered.forEach(i => {
                const card = document.createElement('div');
                let isExpiringSoon = false;
                if (i.type === 'loan' && i.endDate) {
                    const daysLeft = (new Date(i.endDate) - now) / 86400000;
                    if (daysLeft >= 0 && daysLeft <= 30) isExpiringSoon = true;
                }
                card.className = `p-5 rounded-[1.5rem] shadow-sm border mb-3 ${isExpiringSoon ? 'bg-rose-50 border-rose-200' : 'bg-white border-slate-100'}`;
                
                let detail = '';
                if (i.type === 'credit_loan') {
                    const emi = i.customEMI > 0 ? i.customEMI : calcEMI(i.price, i.rate, i.totalTerm);
                    const bal = i.customBalance > 0 ? i.customBalance : calcCreditBalance(i.price, i.rate, i.totalTerm, i.remainingTerm);
                    detail = `<div class="text-xs space-y-1"><p class="text-rose-500 font-bold text-right text-sm">é¤˜é¡: $${Math.round(bal).toLocaleString()}</p><p>æ¯æœˆé‚„æ¬¾: $${Math.round(emi).toLocaleString()} | å‰©é¤˜æœŸæ•¸: ${i.remainingTerm} / ${i.totalTerm}</p><p class="text-slate-400">é‚„æ¬¾æ—¥: æ¯æœˆ ${i.dueDay} è™Ÿ</p></div>`;
                } else if (i.type === 'loan') {
                    const itemInt = calcItemInterest(i, now);
                    const itemRatio = i.price > 0 ? ((i.collateralAmount * 1000 * marketPrice) / i.price * 100) : 0;
                    detail = `<div class="text-xs space-y-1"><p class="text-indigo-600 font-bold">ç¶­æŒç‡: ${itemRatio.toFixed(1)}%</p><p class="text-rose-500 font-bold text-right">åˆ©æ¯: $${Math.round(itemInt).toLocaleString()}</p><p class="text-slate-500">åˆ©ç‡: ${i.rate}% | æœ¬é‡‘: $${i.price.toLocaleString()}</p></div>`;
                } else {
                    const calcTxt = (i.type==='div'&&i.divPerShare>0) ? `${i.amount}å¼µ Ã— æ¯è‚¡$${i.divPerShare}` : (i.amount>0 ? `${i.amount}å¼µ / å–®åƒ¹ $${i.price}` : `ç¸½é¡: $${i.price.toLocaleString()}`);
                    detail = `<div class="text-xs text-slate-600 font-medium">${calcTxt}</div>`;
                }

                const dateRange = i.type === 'loan' ? `${i.date} ~ ${i.endDate || 'é€²è¡Œä¸­'}` : i.date;

                card.innerHTML = `<div class="flex justify-between items-start mb-1 text-slate-800 text-sm"><div><span class="font-bold ${i.type==='buy'?'text-emerald-600':'text-indigo-600'}">${getLabel(i.type)}</span><span class="text-[10px] bg-slate-100 text-slate-500 px-2 py-0.5 rounded ml-2">${i.location==='overseas'?'åœ‹å¤–':'åœ‹å…§'}</span><div class="text-[10px] text-slate-300 mt-0.5 font-bold">${dateRange}</div></div><div class="flex gap-4"><button onclick="editData('${i.id}')" class="text-indigo-600 text-xs font-bold">ç·¨è¼¯</button><button onclick="deleteData('${i.id}')" class="text-rose-400 text-xs font-bold">åˆªé™¤</button></div></div><div class="${isExpiringSoon?'bg-white/50':'bg-slate-50'} p-3 rounded-xl mt-2">${detail}${i.comment?`<div class="text-[11px] text-indigo-500 font-bold mt-2 border-t border-slate-200 pt-2 italic"># ${i.comment}</div>`:''}</div>`;
                view.appendChild(card);
            });
        }

        // --- å ±è¡¨èˆ‡åœ–è¡¨ ---
        function renderReports(container, now) {
            const years = db.reduce((acc, i) => { const y = (i.date || "2026").split('-')[0]; if (!acc[y]) acc[y] = { buy:0, buyShares:0, domesticCost:0, sell:0, div:0, int:0 }; const p = i.price || 0, a = i.amount || 0; if (i.type === 'buy') { acc[y].buy += (i.location === 'domestic' ? p * a * 1000 : p); if (i.location === 'domestic') { acc[y].buyShares += a; acc[y].domesticCost += (p * a * 1000); } } else if (i.type === 'sell') { acc[y].sell += (i.location === 'domestic' ? p * a * 1000 : p); } else if (i.type === 'div') { acc[y].div += p; } else if (i.type === 'interest_expense' || i.type === 'loan') { acc[y].int += (i.type === 'loan' ? calcItemInterest(i, now) : p); } return acc; }, {});
            Object.keys(years).sort((a,b)=>b-a).forEach(y => { const d = years[y]; const yearlyAvg = d.buyShares > 0 ? (d.domesticCost / (d.buyShares * 1000)) : 0; container.innerHTML += `<div class="bg-white p-6 rounded-[2rem] border border-indigo-50 mb-4 shadow-sm text-slate-800 font-bold"><h3 class="font-black text-indigo-700 mb-4 text-center text-lg">${y} å¹´åº¦çµ±è¨ˆ</h3><div class="grid grid-cols-2 gap-3 text-slate-700 text-sm"><div class="bg-slate-50 p-3 rounded-xl">ç¸½è²·å…¥: $${Math.round(d.buy).toLocaleString()}</div><div class="bg-slate-50 p-3 rounded-xl">ç¸½è³£å‡º: $${Math.round(d.sell).toLocaleString()}</div><div class="bg-emerald-50 p-3 rounded-xl text-emerald-700 font-bold">é…æ¯: $${Math.round(d.div).toLocaleString()}</div><div class="bg-rose-50 p-3 rounded-xl text-rose-700 font-bold">åˆ©æ¯: $${Math.round(d.int).toLocaleString()}</div><div class="bg-indigo-50 p-3 rounded-xl text-indigo-700 col-span-2 text-center text-xs italic">åœ‹å…§å¹³å‡è²·åƒ¹: $${yearlyAvg.toFixed(2)}</div></div></div>`; });
        }

        function renderCharts(container) {
            container.innerHTML = `<div class="bg-white p-4 rounded-[2rem] border border-slate-100 shadow-sm overflow-hidden text-slate-800"><canvas id="historyChart" style="height: 350px;"></canvas></div><div class="flex justify-around text-[10px] text-slate-400 mt-2 px-4 font-bold"><span class="text-indigo-600">â— åœ‹å…§å¼µæ•¸ (å³è»¸)</span><span>â— é‡‘é¡ (å·¦è»¸)</span></div>`;
            const sorted = [...db].sort((a,b) => new Date(a.date) - new Date(b.date));
            const labels = [], dShares = [], dPL = [], dLoan = [], dAssets = [];
            let curB = 0, curC = 0, curO = 0, curD = 0, curL = 0, curI = 0, curDebt = 0;
            const now = new Date();
            sorted.forEach(i => {
                labels.push(i.date);
                if (i.type === 'credit_loan') { curDebt = calcCreditBalance(i.price, i.rate, i.totalTerm, i.remainingTerm); }
                else {
                    const p = i.price || 0, a = i.amount || 0;
                    if (i.location === 'domestic') { if (i.type === 'buy') { curB += a; curC += (p * a * 1000); } else if (i.type === 'sell') { curB -= a; curC -= (p * a * 1000); } }
                    else { if (i.type === 'buy') curO += i.price; else if (i.type === 'sell') curO -= i.price; }
                    if (i.type === 'div') curD += p; if (i.type === 'loan') { curL += i.price; curI += calcItemInterest(i, now); }
                }
                const v = (curB * marketPrice * 1000) + curO;
                dShares.push(Math.max(0, curB)); dPL.push(v - curC + curD - curI); dLoan.push(curL + curDebt); dAssets.push(v - curI - curL - curDebt);
            });
            const ctx = document.getElementById('historyChart').getContext('2d');
            if (mainChart) mainChart.destroy();
            const yAMin = Math.min(...dPL, ...dAssets, 0);
            const yAMax = Math.max(...dPL, ...dAssets, ...dLoan, 1000000);
            const ySMax = Math.max(...dShares, 10);
            const ySMin = yAMin < 0 ? (yAMin * ySMax / yAMax) : 0;
            mainChart = new Chart(ctx, { type: 'line', data: { labels, datasets: [
                { label: 'å¼µæ•¸ (å³)', data: dShares, borderColor: '#4f46e5', backgroundColor: '#4f46e511', tension: 0.3, pointRadius: 0, yAxisID: 'yS', fill: true },
                { label: 'æç›Š', data: dPL, borderColor: '#ef4444', tension: 0.3, pointRadius: 0, yAxisID: 'yA' },
                { label: 'è² å‚µ', data: dLoan, borderColor: '#f59e0b', tension: 0.3, pointRadius: 0, yAxisID: 'yA' },
                { label: 'ç¸½è³‡ç”¢', data: dAssets, borderColor: '#3B7695', tension: 0.3, pointRadius: 0, yAxisID: 'yA' }
            ]}, options: { responsive: true, maintainAspectRatio: false, scales: { 
                yA: { type: 'linear', position: 'left', min: yAMin, max: yAMax, ticks: { font: { size: 9 }, callback: v => v >= 10000 || v <= -10000 ? (v/10000)+'è¬' : v } },
                yS: { type: 'linear', position: 'right', min: ySMin, max: ySMax, ticks: { font: { size: 9, weight: 'bold' }, color: '#4f46e5', callback: v => v < 0 ? '' : v }, grid: { drawOnChartArea: false } },
                x: { ticks: { font: { size: 8 }, maxRotation: 45 } }
            }, plugins: { legend: { position: 'top', labels: { boxWidth: 8, font: { size: 10 } } } } } });
        }

        // --- åŠŸèƒ½å‡½æ•¸ ---
        function toggleFormFields() {
            const t = document.getElementById('fType').value, loc = document.getElementById('fLocation').value;
            const isCredit = (t === 'credit_loan');
            document.getElementById('fCreditGroup').classList.toggle('hidden', !isCredit);
            document.getElementById('fRateGroup').classList.toggle('hidden', t !== 'loan' && !isCredit);
            document.getElementById('fEndDateGroup').classList.toggle('hidden', t !== 'loan');
            document.getElementById('fCollateralGroup').classList.toggle('hidden', t !== 'loan');
            document.getElementById('fDivPerShareGroup').classList.toggle('hidden', t !== 'div');
            document.getElementById('fAmountGroup').classList.toggle('hidden', isCredit || t === 'loan' || (t !== 'div' && loc === 'overseas'));
            document.getElementById('dateLabel').innerText = isCredit ? 'ç”³è²¸æ—¥æœŸ' : (t === 'loan' ? 'èµ·æ¯æ—¥' : 'æ—¥æœŸ');
            document.getElementById('priceLabel').innerText = isCredit ? 'è²¸æ¬¾ç¸½æœ¬é‡‘' : (t === 'loan' ? 'è³ªæŠ¼æœ¬é‡‘' : (t === 'div' ? 'é…æ¯ç¸½é¡' : (t === 'interest_expense' ? 'çµç®—é‡‘é¡' : 'é‡‘é¡/å–®åƒ¹')));
        }

        function saveData() {
            const id = document.getElementById('editId').value;
            const item = { id: id || Date.now() + Math.random(), location: document.getElementById('fLocation').value, type: document.getElementById('fType').value, date: document.getElementById('fDate').value, endDate: document.getElementById('fEndDate').value, amount: parseFloat(document.getElementById('fAmount').value) || 0, price: parseFloat(document.getElementById('fPrice').value) || 0, rate: parseFloat(document.getElementById('fRate').value) || 0, totalTerm: parseFloat(document.getElementById('fTotalTerm').value) || 0, remainingTerm: parseFloat(document.getElementById('fRemainingTerm').value) || 0, dueDay: parseFloat(document.getElementById('fDueDay').value) || 0, customEMI: parseFloat(document.getElementById('fCustomEMI').value) || 0, customBalance: parseFloat(document.getElementById('fCustomBalance').value) || 0, comment: document.getElementById('fComment').value || '', divPerShare: parseFloat(document.getElementById('fDivPerShare').value) || 0, collateralAmount: parseFloat(document.getElementById('fCollateral').value) || 0 };
            if (id) { const idx = db.findIndex(r => r.id == id); db[idx] = item; } else { db.push(item); }
            localStorage.setItem(DB_KEY, JSON.stringify(db)); closeAllModals(); renderUI();
        }

        function editData(id) {
            const r = db.find(i => i.id == id); if (!r) return; openModal();
            document.getElementById('editId').value = r.id;
            document.getElementById('fLocation').value = r.location;
            document.getElementById('fType').value = r.type;
            document.getElementById('fDate').value = r.date;
            document.getElementById('fPrice').value = r.price;
            document.getElementById('fRate').value = r.rate;
            document.getElementById('fTotalTerm').value = r.totalTerm || '';
            document.getElementById('fRemainingTerm').value = r.remainingTerm || '';
            document.getElementById('fDueDay').value = r.dueDay || '';
            document.getElementById('fCustomEMI').value = r.customEMI || '';
            document.getElementById('fCustomBalance').value = r.customBalance || '';
            document.getElementById('fComment').value = r.comment;
            document.getElementById('fAmount').value = r.amount;
            document.getElementById('fDivPerShare').value = r.divPerShare;
            document.getElementById('fCollateral').value = r.collateralAmount;
            toggleFormFields();
        }

        // --- åŸºç¤å‡½æ•¸ ---
        function getLabel(t) { return {buy:'ğŸ”µ è²·å…¥', sell:'ğŸ”´ è³£å‡º', div:'ğŸ’° é…æ¯', loan:'ğŸ¦ è³ªæŠ¼', credit_loan:'ğŸ¦ ä¿¡è²¸', interest_expense:'â– åˆ©æ¯'}[t] || t; }
        function calcItemInterest(i, now) { if (!i.date) return 0; const s = new Date(i.date); const eL = i.endDate ? new Date(i.endDate) : now; const d = Math.max(0, (Math.min(now, eL) - s) / 86400000); return (parseFloat(i.price) * (parseFloat(i.rate)/100) * (d/365)); }
        function switchTab(t) { activeTab = t; document.querySelectorAll('.tab-btn').forEach(b => { b.classList.toggle('active', b.id === 'tab-'+t); }); renderUI(); }
        function closeAllModals() { document.getElementById('modalOverlay').classList.add('hidden'); ['dataModal','settingsModal','priceModal','excelModal'].forEach(m => document.getElementById(m).classList.add('hidden')); }
        function openModal() { closeAllModals(); document.getElementById('modalOverlay').classList.replace('hidden','flex'); document.getElementById('dataModal').classList.remove('hidden'); document.getElementById('editId').value=''; toggleFormFields(); }
        function openSettingsModal() { closeAllModals(); document.getElementById('modalOverlay').classList.replace('hidden','flex'); document.getElementById('settingsModal').classList.remove('hidden'); }
        function openPriceModal() { closeAllModals(); document.getElementById('modalOverlay').classList.replace('hidden','flex'); document.getElementById('priceModal').classList.remove('hidden'); document.getElementById('mPriceInput').value = marketPrice; }
        function openExcelModal() { closeAllModals(); document.getElementById('modalOverlay').classList.replace('hidden','flex'); document.getElementById('excelModal').classList.remove('hidden'); }
        function updateMarketPrice() { const v = parseFloat(document.getElementById('mPriceInput').value); if(v>0){ marketPrice=v; localStorage.setItem(PRICE_KEY, v); closeAllModals(); renderUI(); } }
        function deleteData(id) { if(confirm('åˆªé™¤ï¼Ÿ')){ db=db.filter(i=>i.id!=id); localStorage.setItem(DB_KEY, JSON.stringify(db)); renderUI(); } }
        function resetData() { if(confirm('æ¸…ç©ºï¼Ÿ')){ localStorage.clear(); location.reload(); } }
        function calcDivTotal() { const t=document.getElementById('fType').value; if(t==='div'){ const s=parseFloat(document.getElementById('fAmount').value)||0,p=parseFloat(document.getElementById('fDivPerShare').value)||0; if(s>0&&p>0) document.getElementById('fPrice').value=Math.round(s*1000*p); } }
        async function exportData() { const now = new Date(); const ts = now.toISOString().split('T')[0]+'_'+now.getHours()+'-'+now.getMinutes(); const b = new Blob([JSON.stringify(db, null, 2)], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `bonds_backup_${ts}.json`; a.click(); }
        function triggerImport() { document.getElementById('importFile').click(); }
        function handleFileImport(e) { const f = e.target.files[0]; if (!f) return; const reader = new FileReader(); reader.onload=(ev)=>{ try{ db=JSON.parse(ev.target.result); localStorage.setItem(DB_KEY,JSON.stringify(db)); location.reload(); }catch(e){alert('æ ¼å¼éŒ¯èª¤');}}; reader.readAsText(f); }
        function processExcelImport() { const rawText = document.getElementById('excelPasteArea').value; if (!rawText.trim()) return; const lines = rawText.trim().split('\n'); let count = 0; lines.forEach(line => { const cols = line.split('\t'); if (cols.length >= 3) { let rawDate = cols[0].trim().replace(/\//g, '-'); const parts = rawDate.split('-'); if (parts.length === 3) { db.push({ id: Date.now() + Math.random(), location: 'domestic', type: 'buy', date: `${parts[0]}-${parts[1].padStart(2, '0')}-${parts[2].padStart(2, '0')}`, amount: parseFloat(cols[1].trim()), price: parseFloat(cols[2].trim()), collateralAmount: 0, rate: 0, endDate: '', comment: '', divPerShare: 0 }); count++; } } }); if (count > 0) { localStorage.setItem(DB_KEY, JSON.stringify(db)); alert(`æˆåŠŸåŒ¯å…¥ ${count} ç­†ï¼`); closeAllModals(); renderUI(); } }
    </script>
</body>
</html>