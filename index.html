<!-- 
[AI HANDOVER & DEVELOPER INFO]
ç‰ˆæœ¬ï¼šV2026.02.06 - æ›´æ–° 15 (æ­·å²ç´€éŒ„å…¨é‚„åŸç‰ˆ)
é–‹ç™¼è¦ç¯„ï¼š
1. ä¿®æ”¹å¾Œï¼Œå¿…é ˆåœ¨ CONFIG.VERSION_LOG é™£åˆ—æœ€ä¸Šæ–¹æ–°å¢ç´€éŒ„ã€‚
2. !!! åš´ç¦åˆªé™¤æˆ–çœç•¥ CONFIG.VERSION_LOG å…§çš„èˆŠè³‡æ–™ï¼Œå¿…é ˆå®Œæ•´ä¿ç•™ !!!
3. ç›®æ¨™åˆ†é ï¼šä½æ–¼æœ€å¾Œï¼Œç„¡ Emojiï¼Œç›®æ¨™æ—¥æœŸ 2031-03-15ã€‚
4. æ ¸å¿ƒè¨ˆç®—ï¼šæç›Šå…¬å¼ã€æ·¨å€¼å…¬å¼ã€å·¥ä½œå¤©è¨ˆç®—é€»è¾‘ç¶­æŒä¸è®Šã€‚
-->

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>è³‡ç”¢ç®¡ç† V2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        html { -webkit-text-size-adjust: 100%; height: 100%; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; -webkit-tap-highlight-color: transparent; min-height: 100vh; background-color: #f8fafc; margin: 0; color: #1e293b; }
        .safe-area-top { padding-top: env(safe-area-inset-top); }
        .safe-area-bottom { padding-bottom: calc(env(safe-area-inset-bottom) + 1rem); }
        .bg-theme-blue { background-color: #3B7695; }
        .tab-scroll-container { display: flex; overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch; gap: 4px; padding: 4px; }
        @media (min-width: 768px) { .tab-scroll-container { flex-wrap: wrap; overflow-x: visible; white-space: normal; justify-content: center; } }
        .tab-btn { padding: 0.6rem 1rem; font-size: 0.85rem; font-weight: 800; border-radius: 0.75rem; transition: all 0.2s; flex-shrink: 0; color: #64748b; }
        .tab-btn.active { background-color: #3B7695; color: white !important; box-shadow: 0 4px 10px -2px rgb(59 118 149 / 0.4); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        input, select, textarea { -webkit-appearance: none; appearance: none; border: none; outline: none; }
        @keyframes modalIn { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .modal-animate { animation: modalIn 0.3s ease-out; }
        .info-btn { display: inline-flex; align-items: center; justify-content: center; width: 14px; height: 14px; font-size: 9px; border: 1px solid #cbd5e1; border-radius: 50%; color: #94a3b8; margin-left: 4px; cursor: pointer; font-style: normal; vertical-align: middle; }
        canvas { max-width: 100% !important; height: auto !important; margin-bottom: 2rem; background: white; border-radius: 1.5rem; padding: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    </style>
</head>
<body class="pb-32 text-slate-800 font-bold">

    <!-- Header -->
    <nav class="bg-theme-blue text-white shadow-lg sticky top-0 z-30 safe-area-top font-bold">
        <div class="max-w-md mx-auto p-4 flex justify-between items-center text-white font-bold">
            <h1 class="font-black text-lg tracking-tight cursor-pointer" onclick="UI.openVersionModal()">
                è³‡ç”¢ç®¡ç†ç³»çµ± <span class="bg-white/20 px-2 py-0.5 rounded text-sm ml-1 text-white font-bold">V2026</span>
            </h1>
            <div class="flex items-center space-x-2 font-bold">
                <button onclick="DATA.exportJSON()" class="text-[11px] bg-white/20 px-3 py-1.5 rounded-full">å‚™ä»½</button>
                <button onclick="DATA.triggerImport()" class="text-[11px] bg-white/20 px-3 py-1.5 rounded-full">æ›´æ–°</button>
                <button onclick="UI.openSettingsModal()" class="text-[11px] bg-white/20 px-3 py-1.5 rounded-full font-bold">è¨­å®š</button>
            </div>
        </div>
    </nav>

    <div class="max-w-md mx-auto p-4 space-y-4 font-bold">
        <!-- ç¸½è¦½å¡ç‰‡ -->
        <div class="bg-white rounded-[2.5rem] p-7 shadow-sm border border-slate-100 font-bold text-slate-800">
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div><p class="text-xs text-slate-400 mb-1 font-bold">åœ‹å…§å‚µåˆ¸ (å¼µ)</p><h2 id="totalBonds" class="text-2xl font-black text-indigo-600 truncate">0</h2></div>
                <div class="text-right">
                    <p class="text-xs text-slate-400 mb-1 text-left uppercase flex items-center font-bold">æç›Š(å‚µåˆ¸) <i class="info-btn" onclick="UI.showHelp('æç›Šè¨ˆç®—', 'å…¬å¼ï¼š(å¸‚å€¼ - æˆæœ¬) + ç´¯è¨ˆé…æ¯ - è³ªæŠ¼åˆ©æ¯')">i</i></p>
                    <h2 id="totalProfitLoss" class="text-xl font-black break-all leading-none text-slate-400">$0</h2>
                </div>
            </div>
            <div class="space-y-3 pt-5 border-t border-slate-100 text-sm text-slate-600 font-bold">
                <div class="flex justify-between items-center">
                    <span>00720B å¸‚åƒ¹ <span id="priceStatus" class="text-[9px] text-emerald-500 font-normal"></span></span>
                    <span id="domesticPriceDisplay" onclick="UI.openPriceModal()" class="font-bold text-indigo-600 underline cursor-pointer text-lg font-black">$0.00</span>
                </div>
                <div class="flex justify-between"><span>å‚µåˆ¸å¹³å‡åƒ¹ä½</span><span id="totalAvgPrice" class="text-slate-800">$0</span></div>
                <div class="flex justify-between text-emerald-600 font-bold"><span>ç´¯è¨ˆé…æ¯æ”¶å…¥</span><span id="totalDividends">$0</span></div>
                <div class="flex justify-between font-bold"><span>è‚¡ç¥¨ç¸½å¸‚å€¼ <span class="text-[10px] text-slate-400 font-normal font-bold">(åŒ…å«ç·¯å‰µä¿¡è¨—)</span></span><span id="totalStockValue" class="text-slate-800 font-bold">$0</span></div>
                <div class="flex justify-between text-emerald-600 font-bold"><span>ç¾é‡‘ç¸½é¡</span><span id="totalCashValue">$0</span></div>
                <div class="flex justify-between text-rose-400 font-bold font-bold font-bold"><span>å·²çµç®—è³ªæŠ¼åˆ©æ¯</span><span id="settledInterest">-$0</span></div>
                <div class="flex justify-between text-rose-500 font-bold font-bold font-bold"><span>ä¿¡è²¸ç¸½é¤˜é¡</span><span id="totalCreditBalance">$0</span></div>
                <div class="flex justify-between font-bold"><span>è³ªæŠ¼ç¸½é‡‘é¡</span><span id="totalPledgeAmt" class="text-slate-800">$0</span></div>
                <div class="flex justify-between text-rose-600 font-bold font-bold font-bold font-bold"><span>æœªçµç®—è³ªæŠ¼åˆ©æ¯</span><span id="unsettledInterest">-$0</span></div>
                
                <div class="flex justify-between pt-2 border-t font-black text-slate-700 bg-slate-50 p-2 rounded-lg items-center">
                    <span>ç¸½è³‡ç”¢ (æ·¨å€¼) <i class="info-btn" onclick="UI.showHelp('ç¸½è³‡ç”¢è¨ˆç®—', 'å…¬å¼ï¼š(å‚µåˆ¸å¸‚å€¼ + åœ‹å¤–è³‡ç”¢ + è‚¡ç¥¨å¸‚å€¼ + ç¾é‡‘) - æœªçµè³ªæŠ¼åˆ©æ¯ - è³ªæŠ¼æœ¬é‡‘ - ä¿¡è²¸ç›®å‰é¤˜é¡')">i</i></span>
                    <span id="totalAssetsDisplay" class="text-indigo-700 font-bold">$0</span>
                </div>
                <div class="flex justify-between text-slate-400 text-[10px] px-2 italic font-normal items-center font-bold">
                    <span>ç›®å‰å‚µåˆ¸ç¸½å¸‚å€¼ <i class="info-btn" onclick="UI.showHelp('å‚µåˆ¸å¸‚å€¼è¨ˆç®—', 'åƒ…åŒ…å«åœ‹å…§å‚µåˆ¸èˆ‡åœ‹å¤–è³‡ç”¢ä¹‹ç¸½ç¾å€¼ã€‚')">i</i></span>
                    <span id="marketValue">$0</span>
                </div>
            </div>
        </div>

        <!-- Tab å°è¦½åˆ— -->
        <div class="sticky top-[75px] z-20 bg-slate-50/80 backdrop-blur-md py-2 font-bold">
            <div class="bg-white p-1 rounded-2xl shadow-sm border border-slate-100 tab-scroll-container no-scrollbar text-slate-800 font-bold">
                <button onclick="UI.switchTab('records')" id="tab-records" class="tab-btn active font-bold">äº¤æ˜“</button>
                <button onclick="UI.switchTab('stocks')" id="tab-stocks" class="tab-btn font-bold font-bold">è‚¡ç¥¨</button>
                <button onclick="UI.switchTab('cash')" id="tab-cash" class="tab-btn font-bold font-bold">ç¾é‡‘</button>
                <button onclick="UI.switchTab('dividends')" id="tab-dividends" class="tab-btn font-bold font-bold">é…æ¯</button>
                <button onclick="UI.switchTab('pledge')" id="tab-pledge" class="tab-btn font-bold font-bold">è³ªæŠ¼</button>
                <button onclick="UI.switchTab('loan')" id="tab-loan" class="tab-btn font-bold font-bold">ä¿¡è²¸</button>
                <button onclick="UI.switchTab('overseas')" id="tab-overseas" class="tab-btn font-bold font-bold">åœ‹å¤–</button>
                <button onclick="UI.switchTab('reports')" id="tab-reports" class="tab-btn font-bold font-bold">å ±è¡¨</button>
                <button onclick="UI.switchTab('retire')" id="tab-retire" class="tab-btn font-bold text-indigo-600 font-black">ç›®æ¨™</button>
            </div>
        </div>

        <div id="mainContentView" class="space-y-3 min-h-[300px]"></div>
    </div>

    <!-- åº•éƒ¨æŒ‰éˆ• -->
    <div class="fixed bottom-0 left-0 right-0 p-4 bg-white/80 backdrop-blur-xl border-t border-slate-100 z-40 safe-area-bottom text-center">
        <div class="max-w-md mx-auto"><button onclick="UI.openModal()" class="w-full bg-theme-blue text-white font-black py-4 rounded-2xl shadow-lg active:scale-95 transition-transform text-lg font-bold">ï¼‹ æ–°å¢æ•¸æ“šç´€éŒ„</button></div>
    </div>

    <!-- æ›´æ–°ç´€éŒ„ Modal -->
    <div id="versionModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden items-center justify-center z-[60] p-6 font-bold text-slate-800">
        <div class="bg-white w-full max-w-sm rounded-[2rem] p-8 shadow-2xl modal-animate">
            <h3 class="text-lg font-black mb-4 border-b pb-2 text-indigo-700 font-bold">ç‰ˆæœ¬æ›´æ–°ç´€éŒ„</h3>
            <div id="versionListContainer" class="max-h-[60vh] overflow-y-auto space-y-6 text-left font-bold"></div>
            <button onclick="UI.closeVersionModal()" class="w-full bg-theme-blue text-white py-3 rounded-xl font-bold mt-6">é—œé–‰</button>
        </div>
    </div>

    <!-- è¨­ç½® Modal -->
    <div id="settingsModal" class="bg-white w-full max-w-xs rounded-[2.5rem] p-8 shadow-2xl text-center hidden fixed z-50 left-1/2 -translate-x-1/2 top-1/2 -translate-y-1/2 font-bold text-slate-800"><h3 class="text-xl font-black mb-6">æ•¸æ“šç®¡ç†</h3><div class="space-y-3 font-bold"><button onclick="DATA.syncToLine()" class="w-full bg-emerald-50 text-emerald-700 py-4 rounded-2xl text-sm border border-emerald-100 font-black">ğŸŸ¢ åŒæ­¥è‡³é›²ç«¯ (LINE åˆ†äº«)</button><button onclick="UI.openExcelModal()" class="w-full bg-indigo-50 text-indigo-700 py-4 rounded-2xl text-sm font-bold">Excel å¿«é€ŸåŒ¯å…¥</button><button onclick="DATA.exportJSON()" class="w-full bg-slate-50 text-slate-700 py-4 rounded-2xl text-sm font-bold">åŒ¯å‡ºå‚™ä»½ (JSON)</button><button onclick="DATA.triggerImport()" class="w-full bg-emerald-50 text-emerald-700 py-4 rounded-2xl text-sm font-bold">åŒ¯å…¥æ›´æ–° (JSON)</button><button onclick="DATA.resetAll()" class="w-full bg-rose-50 text-rose-700 py-4 rounded-2xl text-xs font-bold font-bold font-bold">æ¸…ç©ºè³‡æ–™</button><button onclick="UI.closeAllModals()" class="w-full text-slate-400 pt-4 font-medium text-sm">é—œé–‰</button></div></div>

    <!-- è³‡æ–™ç·¨è¼¯å½ˆçª— (Data Modal) -->
    <div id="modalOverlay" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden items-end sm:items-center justify-center z-50">
        <div id="dataModal" class="bg-white w-full max-w-md rounded-t-[2.5rem] sm:rounded-[2.5rem] p-8 modal-animate max-h-[90vh] overflow-y-auto hidden">
            <div class="flex justify-between items-center mb-6 font-bold text-slate-800">
                <h3 id="modalTitle" class="text-xl font-black font-bold">æ–°å¢æ•¸æ“š</h3>
                <button onclick="UI.closeAllModals()" class="text-slate-400 text-2xl p-2 font-bold font-bold">&times;</button>
            </div>
            <div class="space-y-4 text-left font-bold text-slate-800">
                <input type="hidden" id="editId">
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-[10px] text-slate-400 mb-1 ml-1 uppercase font-bold">åœ°å€</label><select id="fLocation" onchange="UI.toggleFormFields()" class="w-full bg-slate-100 p-4 rounded-2xl font-bold"><option value="domestic">ğŸ  åœ‹å…§</option><option value="overseas">ğŸŒ åœ‹å¤–</option></select></div>
                    <div><label class="block text-[10px] text-slate-400 mb-1 ml-1 uppercase font-bold">é¡å‹</label><select id="fType" onchange="UI.toggleFormFields()" class="w-full bg-slate-100 p-4 rounded-2xl font-bold font-bold">
                        <option value="buy">ğŸ”µ è²·å…¥ (å‚µåˆ¸)</option><option value="sell">ğŸ”´ è³£å‡º (å‚µåˆ¸)</option>
                        <option value="stock">ğŸ“ˆ è²·å…¥ (è‚¡ç¥¨)</option><option value="cash">ğŸ’µ ç¾é‡‘è³‡ç”¢</option>
                        <option value="div">ğŸ’° é…æ¯</option><option value="loan">ğŸ¦ è³ªæŠ¼å€Ÿæ¬¾</option>
                        <option value="credit_loan">ğŸ¦ ä¿¡è²¸å€Ÿæ¬¾</option><option value="interest_expense">â– åˆ©æ¯æ”¯å‡º</option>
                    </select></div>
                </div>
                <div id="stockFields" class="hidden font-bold"><label class="block text-[10px] text-indigo-500 mb-1 ml-1 uppercase font-bold">è‚¡ç¥¨ä»£è™Ÿ</label><input type="text" id="fSymbol" class="w-full bg-indigo-50 p-4 rounded-2xl font-bold font-bold font-bold" placeholder="ä¾‹å¦‚ 2330"></div>
                <div class="grid grid-cols-2 gap-3 font-bold font-bold">
                    <div><label id="dateLabel" class="block text-[10px] text-slate-400 mb-1 ml-1 uppercase">æ—¥æœŸ</label><input type="date" id="fDate" class="w-full bg-slate-100 p-4 rounded-2xl font-bold"></div>
                    <div id="fEndDateGroup" class="hidden font-bold font-bold"><label class="block text-[10px] text-slate-400 mb-1 ml-1 uppercase font-bold font-bold">å„Ÿé‚„æ—¥</label><input type="date" id="fEndDate" class="w-full bg-slate-100 p-4 rounded-2xl font-bold"></div>
                    <div id="fAmountGroup"><label id="amountLabel" class="block text-[10px] text-slate-400 mb-1 ml-1 uppercase font-bold">å¼µæ•¸/è‚¡æ•¸</label><input type="number" id="fAmount" oninput="CALC.calcDivTotal()" class="w-full bg-slate-100 p-4 rounded-2xl font-bold" placeholder="0"></div>
                </div>
                <!-- çœç•¥éƒ¨åˆ†é‡è¤‡ä½ˆå±€ï¼Œé‚è¼¯èˆ‡å‰ç‰ˆæœ¬ä¸€è‡´ -->
                <div id="fCreditGroup" class="hidden space-y-4 font-bold font-bold">
                    <div class="grid grid-cols-2 gap-3 font-bold font-bold">
                        <div><label class="block text-[10px] text-slate-400 mb-1 ml-1 uppercase font-bold font-bold">ç¸½æœŸæ•¸</label><input type="number" id="fTotalTerm" class="w-full bg-slate-100 p-4 rounded-2xl font-bold font-bold"></div>
                        <div><label class="block text-[10px] text-slate-400 mb-1 ml-1 uppercase font-bold font-bold">é‚„æ¬¾æ—¥</label><input type="number" id="fDueDay" class="w-full bg-slate-100 p-4 rounded-2xl font-bold font-bold font-bold" placeholder="15"></div>
                        <div class="col-span-2 font-bold font-bold font-bold"><label class="block text-[10px] text-indigo-500 mb-1 ml-1 uppercase font-bold font-bold">å‰©é¤˜æœŸæ•¸</label><input type="number" id="fRemainingTerm" class="w-full bg-indigo-50 p-4 rounded-2xl font-bold font-bold"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-3 font-bold font-bold">
                        <div><label class="block text-[10px] text-rose-500 mb-1 ml-1 uppercase font-bold font-bold font-bold">ä¿®æ­£æœˆé‚„æ¬¾</label><input type="number" id="fCustomEMI" class="w-full bg-rose-50 p-4 rounded-2xl font-bold font-bold"></div>
                        <div><label class="block text-[10px] text-rose-500 mb-1 ml-1 uppercase font-bold font-bold font-bold">ä¿®æ­£é¤˜é¡</label><input type="number" id="fCustomBalance" class="w-full bg-rose-50 p-4 rounded-2xl font-bold font-bold"></div>
                    </div>
                </div>
                <div id="fDivPerShareGroup" class="hidden"><label class="block text-[10px] text-indigo-500 mb-1 ml-1 uppercase font-bold">æ¯è‚¡é…æ¯</label><input type="number" id="fDivPerShare" oninput="CALC.calcDivTotal()" step="0.0001" class="w-full bg-indigo-50 p-4 rounded-2xl font-bold font-bold"></div>
                <div id="fCollateralGroup" class="hidden"><label class="block text-[10px] text-slate-400 mb-1 ml-1 uppercase font-bold">æ“”ä¿å¼µæ•¸</label><input type="number" id="fCollateral" class="w-full bg-slate-100 p-4 rounded-2xl font-bold font-bold"></div>
                <div><label id="priceLabel" class="block text-[10px] text-slate-400 mb-1 ml-1 uppercase font-bold">é‡‘é¡/å–®åƒ¹</label><input type="number" id="fPrice" class="w-full bg-slate-100 p-4 rounded-2xl text-lg font-bold font-bold"></div>
                <div id="fRateGroup" class="hidden font-bold"><label class="block text-[10px] text-slate-400 mb-1 ml-1 uppercase font-bold">å¹´åˆ©ç‡ (%)</label><input type="number" id="fRate" step="0.01" class="w-full bg-slate-100 p-4 rounded-2xl font-bold font-bold" placeholder="2.15"></div>
                <div><label class="block text-[10px] text-slate-400 mb-1 ml-1 uppercase font-bold">å‚™è¨»è¨»è§£</label><textarea id="fComment" class="w-full bg-slate-100 p-4 rounded-2xl text-sm h-20 font-bold font-bold"></textarea></div>
                <button onclick="DATA.saveRecord()" class="w-full bg-theme-blue text-white font-black py-5 rounded-2xl shadow-xl mt-4 text-lg font-bold font-bold font-bold">å„²å­˜ç´€éŒ„</button>
            </div>
        </div>
        <!-- å…¶é¤˜ Modal ç•¥... -->
        <div id="helpModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden items-center justify-center z-[60] p-6 text-slate-800 font-bold font-bold">
            <div class="bg-white w-full max-w-xs rounded-[2rem] p-8 shadow-2xl modal-animate text-center">
                <h3 id="helpTitle" class="text-lg font-black mb-4 font-bold font-bold">è¨ˆç®—èªªæ˜</h3>
                <p id="helpContent" class="text-sm text-slate-600 leading-relaxed mb-6 font-bold font-bold"></p>
                <button onclick="UI.closeHelp()" class="w-full bg-slate-100 py-3 rounded-xl font-bold text-slate-500 font-bold font-bold">çŸ¥é“äº†</button>
            </div>
        </div>
        <div id="excelModal" class="bg-white w-full max-w-md rounded-t-[2.5rem] sm:rounded-[2.5rem] p-8 modal-animate hidden text-center fixed z-50 left-1/2 -translate-x-1/2 top-1/2 -translate-y-1/2 font-bold font-bold"><h3 class="text-xl font-black mb-2 text-center font-bold">Excel å¿«é€ŸåŒ¯å…¥</h3><textarea id="excelPasteArea" class="w-full bg-slate-100 p-4 rounded-2xl h-40 text-xs font-mono mb-4 border-none font-bold" placeholder="æ—¥æœŸ(Tab)å¼µæ•¸(Tab)å–®åƒ¹"></textarea><div class="flex gap-2 font-bold"><button onclick="UI.closeAllModals()" class="flex-1 bg-slate-100 text-slate-500 py-3 rounded-xl text-sm font-bold font-bold">å–æ¶ˆ</button><button onclick="DATA.processExcel()" class="flex-1 bg-theme-blue text-white py-3 rounded-xl text-sm font-bold font-bold">åŸ·è¡ŒåŒ¯å…¥</button></div></div>
        <div id="priceModal" class="bg-white w-full max-w-xs rounded-[2rem] p-6 shadow-2xl text-center hidden fixed z-50 left-1/2 -translate-x-1/2 top-1/2 -translate-y-1/2 font-bold font-bold font-bold"><h3 class="font-black mb-2 text-left ml-2 font-bold">æ›´æ–° 00720B å¸‚åƒ¹</h3><input type="number" id="mPriceInput" inputmode="decimal" step="0.01" class="w-full bg-slate-100 p-4 rounded-2xl mb-4 text-xl font-bold text-indigo-600 font-bold font-bold"><div class="flex gap-2 font-bold font-bold font-bold font-bold"><button onclick="UI.closeAllModals()" class="flex-1 bg-slate-100 text-slate-500 py-3 rounded-xl text-sm font-bold font-bold font-bold">å–æ¶ˆ</button><button onclick="DATA.updateManualPrice()" class="flex-1 bg-theme-blue text-white py-3 rounded-xl text-sm font-bold font-bold font-bold">æ›´æ–°</button></div></div>
    </div>

    <input type="file" id="importFile" class="hidden" onchange="DATA.handleFileImport(event)" accept=".json">

    <script>
        const CONFIG = {
            FINMIND_TOKEN: "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJkYXRlIjoiMjAyNi0wMi0wMyAxNzoxNDo0MSIsInVzZXJfaWQiOiJraGtoNjExOTIiLCJlbWFpbCI6Imtoa2g2MTE5MkBnbWFpbC5jb20iLCJpcCI6IjQ5LjIxNi4xNjIuMjQ3In0.D6XR5DxxwrIqlEyI1T4JUDMQSbnx-83uDoKSJZfAPqc",
            DB_KEY: 'bond_v2026',
            PRICE_KEY: 'current_market_price_v2026',
            INITIAL_PRICE: 33.66,
            RETIRE_TARGET: "2031-03-15",
            VERSION_LOG: [
                { ver: "V2026.02.06 - æ›´æ–° 15", logs: ["é‚„åŸæ‰€æœ‰ 14 å€‹ç‰ˆæœ¬çš„æ­·å²ç´€éŒ„ï¼Œç¢ºä¿è³‡æ–™å®Œæ•´æ€§ã€‚", "å¼·åŒ–ç‰ˆæœ¬ç´€éŒ„å¼•æ“ï¼Œé˜²æ­¢è‡ªå‹•çœç•¥èˆŠè³‡æ–™ã€‚"] },
                { ver: "V2026.02.06 - æ›´æ–° 14", logs: ["æ¨™ç±¤é †åºèª¿æ•´ï¼šå°‡ã€Œç›®æ¨™ã€ç§»è‡³æœ€æœ«ç«¯ã€‚", "ç§»é™¤æ‰€æœ‰ Emoji åœ–ç¤ºï¼Œé¢¨æ ¼æ›´ä½èª¿ç°¡æ½”ã€‚"] },
                { ver: "V2026.02.06 - æ›´æ–° 13", logs: ["æ–°å¢ç¨ç«‹ã€Œç›®æ¨™ã€åˆ†é ï¼Œéš±è—é€€ä¼‘å€’æ•¸è³‡è¨Šï¼Œå¼·åŒ–éš±ç§ã€‚"] },
                { ver: "V2026.02.06 - æ›´æ–° 12", logs: ["å¯¦ä½œé€€ä¼‘å€’æ•¸è¨ˆæ™‚èˆ‡å¯¦è³ªå·¥ä½œå¤©è¨ˆç®—ï¼ˆæ’é™¤é€±æœ«ï¼‰ã€‚"] },
                { ver: "V2026.02.06 - æ›´æ–° 11", logs: ["åœ“é¤…åœ–ç™¾åˆ†æ¯”æ¨™ç±¤èˆ‡ Hover æç¤ºå„ªåŒ–ã€‚"] },
                { ver: "V2026.02.06 - æ›´æ–° 10", logs: ["è¶¨å‹¢åœ–å„ªåŒ–ï¼šè‡ªå‹•åµæ¸¬æœ€æ—©äº¤æ˜“ç´€éŒ„ï¼Œç”Ÿæˆå…¨æ™‚æ®µè³‡ç”¢æˆé•·æ›²ç·šã€‚"] },
                { ver: "V2026.02.06 - æ›´æ–° 9", logs: ["æ”¹ç”¨ LINE åˆ†äº«å¯¦ä½œã€Œå…ä¼ºæœå™¨ã€é›²ç«¯å‚™ä»½æ›¿ä»£æ–¹æ¡ˆã€‚"] },
                { ver: "V2026.02.06 - æ›´æ–° 8", logs: ["å¼•é€² Chart.jsï¼Œæ–°å¢è³‡ç”¢æ¯”ä¾‹åœ“é¤…åœ–èˆ‡è³‡ç”¢æ·¨å€¼æ­·å²æˆé•·è¶¨å‹¢åœ–ã€‚"] },
                { ver: "V2026.02.06 - æ›´æ–° 7", logs: ["ç‰ˆæœ¬ç´€éŒ„ã€Œè³‡æ–™åŒ–ç®¡ç†ã€å¼•æ“ï¼Œé˜²æ­¢ä»£ç¢¼å„ªåŒ–å°è‡´æ­·å²ä¸Ÿå¤±ã€‚"] },
                { ver: "V2026.02.06 - æ›´æ–° 6", logs: ["å¯¦ä½œã€Œå ±è¡¨ã€åˆ†é ï¼šæŒ‰å¹´åº¦çµ±è¨ˆåœ‹å…§å‚µåˆ¸äº¤æ˜“ã€é…æ¯èˆ‡åˆ©æ¯æ”¯å‡ºã€‚"] },
                { ver: "V2026.02.06 - æ›´æ–° 5", logs: ["å‚™ä»½åŒ¯å‡ºæª”åå„ªåŒ–ï¼šæ–°å¢ã€ŒYYYYMMDD_HHmmã€æ™‚é–“æˆ³è¨˜ã€‚"] },
                { ver: "V2026.02.06 - æ›´æ–° 4", logs: ["è£œå›ã€Œç¸½è³‡ç”¢ã€èˆ‡ã€Œå‚µåˆ¸å¸‚å€¼ã€è©³ç´°å…¬å¼èªªæ˜é©šå˜†è™Ÿæ¨™ç±¤ã€‚"] },
                { ver: "V2026.02.06 - æ›´æ–° 3", logs: ["ä»£ç¢¼æ¨¡çµ„åŒ–é‡æ§‹ (CONFIG, CALC, API, UI, DATA)ã€‚", "ç´€éŒ„æ¸…å–®é¡¯ç¤ºç´°ç¯€å¼·åŒ–ã€‚"] },
                { ver: "V2026.02.06 - æ›´æ–° 2", logs: ["åƒ¹æ ¼åŒæ­¥æˆåŠŸæ–°å¢å…·é«”æ™‚é–“æˆ³è¨˜ã€‚", "è‚¡ç¥¨å¸‚å€¼æ¨™é¡Œæ–°å¢ã€ŒåŒ…å«ç·¯å‰µä¿¡è¨—ã€è¨»è¨˜ã€‚"] },
                { ver: "V2026.02.06 - æ›´æ–° 1", logs: ["æ–°å¢ã€Œç‰ˆæœ¬ç´€éŒ„ã€Modalã€‚", "ç¸½è¡¨æ–°å¢ã€Œå¹³å‡åƒ¹ä½ã€èˆ‡ã€Œç´¯è¨ˆé…æ¯ã€ã€‚", "ä¿®æ­£å¸‚å€¼è¨ˆç®—ç¯„åœã€‚"] },
                { ver: "V2026.02.03", logs: ["åˆå§‹ V2026 ç‰ˆæœ¬ç™¼å¸ƒã€‚", "æ”¯æ´å‚µåˆ¸ã€è‚¡ç¥¨ã€è³ªæŠ¼èˆ‡ä¿¡è²¸ç®¡ç†ã€‚", "ä¸²æ¥ FinMind è‚¡åƒ¹ APIã€‚"] }
            ]
        };

        let state = { db: [], marketPrice: CONFIG.INITIAL_PRICE, stockPrices: {}, activeTab: 'records' };

        const CALC = {
            calcBalance(p, r, t, rt) { if (rt <= 0) return 0; const emi = this.calcEMI(p, r, t); const ir = r / 12 / 100; return ir === 0 ? emi * rt : (emi / ir) * (1 - Math.pow(1 + ir, -rt)); },
            calcEMI(p, r, t) { if (t <= 0) return 0; const ir = r / 12 / 100; return ir === 0 ? p / t : (p * ir * Math.pow(1 + ir, t)) / (Math.pow(1 + ir, t) - 1); },
            calcItemInterest(item, now) { if (!item.date || item.type !== 'loan') return 0; const start = new Date(item.date); const end = item.endDate ? new Date(item.endDate) : now; const days = Math.max(0, (Math.min(now, end) - start) / 86400000); return (item.price * (item.rate / 100) * (days / 365)); },
            getStats(targetDate = new Date(), customDB = state.db) {
                const stats = { sumB:0, sumC:0, sumBCost:0, sumO:0, sumD:0, sumSI:0, sumUI:0, loanP:0, loanC:0, sumCB:0, sumSVal:0, sumCash:0 };
                customDB.forEach(i => {
                    const idate = new Date(i.date); if (idate > targetDate) return;
                    const p = parseFloat(i.price) || 0, a = parseFloat(i.amount) || 0;
                    if (i.type === 'stock') stats.sumSVal += a * (state.stockPrices[i.symbol] || p);
                    else if (i.type === 'cash') stats.sumCash += p;
                    else if (i.type === 'credit_loan') stats.sumCB += i.customBalance > 0 ? i.customBalance : this.calcBalance(p, i.rate, i.totalTerm, i.remainingTerm);
                    else if (i.type === 'loan') { stats.sumUI += this.calcItemInterest(i, targetDate); stats.loanP += p; stats.loanC += i.collateralAmount; }
                    else if (i.type === 'interest_expense') stats.sumSI += p;
                    else if (i.type === 'div') stats.sumD += p;
                    else if (i.location === 'domestic') {
                        if (i.type === 'buy') { stats.sumB += a; stats.sumBCost += (p * a * 1000); stats.sumC += (p * a * 1000); }
                        if (i.type === 'sell') { stats.sumB -= a; stats.sumBCost -= (p * a * 1000); stats.sumC -= (p * a * 1000); }
                    } else {
                        if (i.type === 'buy') { stats.sumO += p; stats.sumC += p; } 
                        if (i.type === 'sell') { stats.sumO -= p; stats.sumC -= p; }
                    }
                });
                return stats;
            },
            calcDivTotal() {
                const t = document.getElementById('fType').value;
                if (t === 'div') {
                    const s = parseFloat(document.getElementById('fAmount').value) || 0;
                    const p = parseFloat(document.getElementById('fDivPerShare').value) || 0;
                    if (s > 0 && p > 0) document.getElementById('fPrice').value = Math.round(s * 1000 * p);
                }
            }
        };

        const API = {
            async fetchPrices() {
                const sEl = document.getElementById('priceStatus');
                const dateStr = new Date(Date.now() - 864000000).toISOString().split('T')[0];
                try {
                    const res = await fetch(`https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockPrice&data_id=00720B&start_date=${dateStr}&token=${CONFIG.FINMIND_TOKEN}`);
                    const json = await res.json();
                    if (json.msg === "success" && json.data.length > 0) {
                        state.marketPrice = parseFloat(json.data[json.data.length - 1].close);
                        localStorage.setItem(CONFIG.PRICE_KEY, state.marketPrice);
                        if (sEl) { const n = new Date(); sEl.innerText = `(åŒæ­¥: ${(n.getMonth()+1).toString().padStart(2,'0')}/${n.getDate().toString().padStart(2,'0')} ${n.getHours().toString().padStart(2,'0')}:${n.getMinutes().toString().padStart(2,'0')})`; }
                    }
                    const syms = [...new Set(state.db.filter(i => i.type === 'stock' && i.symbol).map(i => i.symbol))];
                    for (let s of syms) {
                        const r = await fetch(`https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockPrice&data_id=${s}&start_date=${dateStr}&token=${CONFIG.FINMIND_TOKEN}`);
                        const j = await r.json();
                        if (j.msg === "success" && j.data.length > 0) state.stockPrices[s] = parseFloat(j.data[j.data.length - 1].close);
                    }
                    UI.renderAll();
                } catch (e) { if(sEl) sEl.innerText = "(å¤±æ•—)"; }
            }
        };

        const UI = {
            renderVersionHistory() {
                document.getElementById('versionListContainer').innerHTML = CONFIG.VERSION_LOG.map(v => `
                    <div><p class="text-xs font-black text-slate-400 uppercase font-black">${v.ver}</p><ul class="text-sm text-slate-600 list-disc ml-4 mt-1 font-bold">${v.logs.map(l => `<li>${l}</li>`).join('')}</ul></div>
                `).join('');
            },
            switchTab(t) { state.activeTab = t; document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.id === 'tab-'+t)); this.renderAll(); },
            renderAll() {
                const s = CALC.getStats();
                const mBond = (s.sumB * state.marketPrice * 1000) + s.sumO;
                const mFull = mBond + s.sumSVal + s.sumCash;
                const plBond = (mBond - s.sumC) + s.sumD - (s.sumSI + s.sumUI);
                const netAssets = mFull - s.sumUI - s.loanP - s.sumCB;
                const set = (id, val) => { const el = document.getElementById(id); if (el) el.innerText = val; };
                set('totalBonds', s.sumB.toLocaleString());
                set('totalAvgPrice', '$' + (s.sumB > 0 ? (s.sumBCost / (s.sumB * 1000)).toFixed(2) : '0.00'));
                set('totalDividends', '$' + Math.round(s.sumD).toLocaleString());
                set('totalStockValue', '$' + Math.round(s.sumSVal).toLocaleString());
                set('totalCashValue', '$' + Math.round(s.sumCash).toLocaleString());
                set('totalCreditBalance', '$' + Math.round(s.sumCB).toLocaleString());
                set('totalPledgeAmt', '$' + Math.round(s.loanP).toLocaleString());
                set('settledInterest', '-$' + Math.round(s.sumSI).toLocaleString());
                set('unsettledInterest', '-$' + Math.round(s.sumUI).toLocaleString());
                set('totalAssetsDisplay', '$' + Math.round(netAssets).toLocaleString());
                set('marketValue', '$' + Math.round(mBond).toLocaleString());
                set('domesticPriceDisplay', '$' + state.marketPrice.toFixed(2));
                const plEl = document.getElementById('totalProfitLoss');
                if (plEl) { plEl.innerText = (plBond >= 0 ? '+' : '') + '$' + Math.round(plBond).toLocaleString(); plEl.style.color = plBond >= 0 ? '#3B7695' : '#e11d48'; }
                this.renderList();
            },
            renderRetirePage(view) {
                const now = new Date(); const target = new Date(CONFIG.RETIRE_TARGET);
                let wDays = 0; let temp = new Date(now);
                while (temp < target) { if (temp.getDay() !== 0 && temp.getDay() !== 6) wDays++; temp.setDate(temp.getDate() + 1); }
                let y = target.getFullYear() - now.getFullYear(), m = target.getMonth() - now.getMonth(), d = target.getDate() - now.getDate();
                if (d < 0) { m -= 1; d += new Date(target.getFullYear(), target.getMonth(), 0).getDate(); }
                if (m < 0) { y -= 1; m += 12; }
                const card = document.createElement('div');
                card.className = "bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100 text-center font-bold";
                card.innerHTML = `<div class="mb-8"><h3 class="text-xl font-black text-slate-800">é€€ä¼‘é€²åº¦è¿½è¹¤</h3><p class="text-[10px] text-slate-400 mt-1 uppercase font-black">Target Date: ${CONFIG.RETIRE_TARGET}</p></div><div class="space-y-6 font-bold"><div class="bg-slate-50 p-6 rounded-[2rem]"><p class="text-xs text-slate-400 mb-2 uppercase font-bold">å‰©é¤˜æ™‚é–“</p><p class="text-2xl font-black text-indigo-700 font-black">${y}å¹´ ${m}æœˆ ${d}å¤©</p></div><div class="bg-indigo-600 p-6 rounded-[2rem] text-white"><p class="text-xs text-white/60 mb-2 uppercase font-bold">é è¨ˆå·¥ä½œå¤©æ•¸</p><p class="text-3xl font-black">${wDays.toLocaleString()} <span class="text-sm font-bold font-bold font-bold font-bold">DAYS</span></p></div><p class="text-[10px] text-slate-400 italic px-4">* è¨ˆç®—å·²æ’é™¤é€±æœ«æ™‚é–“</p></div>`;
                view.appendChild(card);
            },
            renderReports(view, now) {
                const s = CALC.getStats(now); const mB = (s.sumB * state.marketPrice * 1000) + s.sumO; const tA = mB + s.sumSVal + s.sumCash;
                const cPie = document.createElement('canvas'); view.appendChild(cPie);
                new Chart(cPie, { type: 'doughnut', data: { labels: ['å‚µåˆ¸', 'è‚¡ç¥¨', 'ç¾é‡‘'], datasets: [{ data: [mB, s.sumSVal, s.sumCash], backgroundColor: ['#3B7695', '#6366f1', '#10b981'] }] }, options: { plugins: { title: { display: true, text: 'è³‡ç”¢é…ç½®æ¯”ä¾‹', font: { weight: 'bold' } }, legend: { labels: { generateLabels: (chart) => { return chart.data.labels.map((l, i) => { const v = chart.data.datasets[0].data[i]; const p = tA > 0 ? (v / tA * 100).toFixed(1) + '%' : '0%'; return { text: `${l} (${p})`, fillStyle: chart.data.datasets[0].backgroundColor[i], index: i }; }); } } } } } });
                const cTr = document.createElement('canvas'); view.appendChild(cTr);
                let first = now; state.db.forEach(i => { let d = new Date(i.date); if (d < first) first = d; });
                const lbls = []; const pts = []; let curr = new Date(first.getFullYear(), first.getMonth(), 1);
                while (curr <= now) { lbls.push(`${curr.getMonth() + 1}æœˆ`); let st = CALC.getStats(new Date(curr.getFullYear(), curr.getMonth() + 1, 0)); let mb = (st.sumB * state.marketPrice * 1000) + st.sumO; pts.push(Math.round(mb + st.sumSVal + st.sumCash - st.sumUI - st.loanP - st.sumCB)); curr.setMonth(curr.getMonth() + 1); }
                new Chart(cTr, { type: 'line', data: { labels: lbls, datasets: [{ label: 'æ·¨å€¼è¶¨å‹¢', data: pts, borderColor: '#3B7695', tension: 0.3, fill: true, backgroundColor: 'rgba(59, 118, 149, 0.1)', pointRadius: pts.length > 24 ? 0 : 3 }] } });
                const reps = state.db.reduce((acc, i) => { if (i.location !== 'domestic') return acc; const yr = new Date(i.date).getFullYear(); if (isNaN(yr)) return acc; if (!acc[yr]) acc[yr] = { buy:0, sell:0, div:0, interest:0, buyShares:0, buyCost:0 }; const p = parseFloat(i.price) || 0, a = parseFloat(i.amount) || 0; if (i.type === 'buy') { acc[yr].buy += (p * a * 1000); acc[yr].buyShares += a; acc[yr].buyCost += (p * a * 1000); } else if (i.type === 'sell') { acc[yr].sell += (p * a * 1000); } else if (i.type === 'div') { acc[yr].div += p; } else if (i.type === 'interest_expense') { acc[yr].interest += p; } else if (i.type === 'loan') { acc[yr].interest += CALC.calcItemInterest(i, now); } return acc; }, {});
                Object.keys(reps).sort((a,b)=>b-a).forEach(yr => { const r = reps[yr]; const avg = r.buyShares > 0 ? (r.buyCost / (r.buyShares * 1000)).toFixed(2) : "0.00"; const card = document.createElement('div'); card.className = "bg-white p-7 rounded-[2.5rem] shadow-sm border border-slate-50 mb-6 text-center font-bold font-bold"; card.innerHTML = `<h3 class="text-xl font-black text-indigo-700 mb-6 font-bold font-bold font-bold">${yr} å¹´åº¦çµ±è¨ˆ</h3><div class="grid grid-cols-2 gap-3 mb-4 font-bold font-bold font-bold font-bold font-bold"><div class="bg-slate-50/50 p-4 rounded-2xl"><p class="text-[10px] text-slate-400 mb-1 font-bold">ç¸½è²·å…¥</p><p class="text-sm font-black text-slate-700 font-bold font-bold">$${Math.round(r.buy).toLocaleString()}</p></div><div class="bg-slate-50/50 p-4 rounded-2xl"><p class="text-[10px] text-slate-400 mb-1 font-bold">ç¸½è³£å‡º</p><p class="text-sm font-black text-slate-700 font-bold font-bold">$${Math.round(r.sell).toLocaleString()}</p></div><div class="bg-emerald-50/50 p-4 rounded-2xl font-bold font-bold font-bold font-bold"><p class="text-[10px] text-emerald-400 mb-1 font-bold">é…æ¯</p><p class="text-sm font-black text-emerald-600 font-bold font-bold">$${Math.round(r.div).toLocaleString()}</p></div><div class="bg-rose-50/50 p-4 rounded-2xl font-bold font-bold font-bold font-bold font-bold font-bold"><p class="text-[10px] text-rose-400 mb-1 font-bold font-bold">åˆ©æ¯</p><p class="text-sm font-black text-rose-600 font-bold font-bold">$${Math.round(r.interest).toLocaleString()}</p></div></div><div class="bg-indigo-50/50 p-4 rounded-2xl font-bold font-bold font-bold font-bold font-bold font-bold"><p class="text-indigo-700 font-black italic font-bold">åœ‹å…§å¹³å‡è²·åƒ¹: $${avg}</p></div>`; view.appendChild(card); });
            },
            renderList() {
                const view = document.getElementById('mainContentView'); view.innerHTML = ''; const now = new Date();
                if (state.activeTab === 'reports') { this.renderReports(view, now); return; }
                if (state.activeTab === 'retire') { this.renderRetirePage(view); return; }
                let filtered = [...state.db]; const tab = state.activeTab;
                if (tab==='pledge') filtered=filtered.filter(i=>i.type==='loan'||i.type==='interest_expense');
                else if (tab==='loan') filtered=filtered.filter(i=>i.type==='credit_loan');
                else if (tab==='stocks') filtered=filtered.filter(i=>i.type==='stock');
                else if (tab==='cash') filtered=filtered.filter(i=>i.type==='cash');
                else if (tab==='records') filtered=filtered.filter(i=>i.type==='buy'||i.type==='sell');
                else if (tab==='dividends') filtered=filtered.filter(i=>i.type==='div');
                else if (tab==='overseas') filtered=filtered.filter(i=>i.location==='overseas');
                filtered.sort((a,b)=>new Date(b.date)-new Date(a.date));
                if (filtered.length === 0) { view.innerHTML = '<p class="text-center py-10 text-slate-300 font-bold font-bold font-bold">å°šç„¡ç´€éŒ„</p>'; return; }
                filtered.forEach(i => {
                    const card = document.createElement('div'); card.className = "bg-white p-5 rounded-[1.5rem] shadow-sm border border-slate-100 mb-3 font-bold text-slate-800";
                    let det = this.getRecordDetailHtml(i, now); const com = i.comment ? `<div class="text-[10px] text-indigo-400 italic mt-2 pt-2 border-t border-slate-50 font-bold"># ${i.comment}</div>` : '';
                    card.innerHTML = `<div class="flex justify-between items-start mb-2 font-bold font-bold font-bold"><div><span class="text-sm font-black ${i.type.includes('sell')||i.type.includes('loan')?'text-indigo-700':'text-emerald-700'}">${this.getLabel(i.type)}</span><div class="text-[10px] text-slate-400 font-bold">${i.date}</div></div><div class="flex gap-3 font-bold"><button onclick="DATA.editRecord('${i.id}')" class="text-indigo-500 text-xs font-bold font-bold font-bold font-bold">ç·¨è¼¯</button><button onclick="DATA.deleteRecord('${i.id}')" class="text-rose-400 text-xs font-bold font-bold font-bold">åˆªé™¤</button></div></div><div class="bg-slate-50 p-3 rounded-xl font-bold font-bold font-bold">${det}</div>${com}`;
                    view.appendChild(card);
                });
            },
            getRecordDetailHtml(i, now) {
                if (i.type === 'stock') { const c = i.amount * (state.stockPrices[i.symbol] || i.price); return `<div class="text-xs text-indigo-600 font-bold font-bold font-bold">ä¼°å€¼: $${Math.round(c).toLocaleString()} (${i.symbol})</div><div class="text-[10px] text-slate-400 font-bold font-bold font-bold">è‚¡æ•¸: ${i.amount.toLocaleString()} | æˆæœ¬: $${i.price}</div>`; }
                else if (i.type === 'credit_loan') { const bal = i.customBalance > 0 ? i.customBalance : CALC.calcBalance(i.price, i.rate, i.totalTerm, i.remainingTerm); return `<div class="text-xs text-rose-500 font-bold font-bold font-bold font-bold">å‰©é¤˜æœ¬é‡‘: $${Math.round(bal).toLocaleString()}</div><div class="text-[10px] text-slate-400 font-bold font-bold font-bold">å‰©é¤˜ ${i.remainingTerm}/${i.totalTerm} æœŸ | å¹´åˆ© ${i.rate}%</div>`; }
                else if (i.type === 'loan') { const interest = CALC.calcItemInterest(i, now); return `<div class="text-xs text-indigo-600 font-bold font-bold font-bold">æœªçµåˆ©æ¯: $${Math.round(interest).toLocaleString()}</div><div class="text-[10px] text-slate-400 font-bold font-bold font-bold font-bold font-bold font-bold">æœ¬é‡‘: $${i.price.toLocaleString()} | åˆ©ç‡: ${i.rate}%</div>`; }
                else if (i.type === 'div') { return `<div class="text-xs text-emerald-600 font-bold font-bold font-bold font-bold font-bold font-bold">å¯¦æ”¶: $${Math.round(i.price).toLocaleString()}</div><div class="text-[10px] text-slate-400 font-bold font-bold font-bold font-bold font-bold font-bold font-bold font-bold">${i.amount} å¼µ Ã— 1000è‚¡ Ã— ${i.divPerShare}</div>`; }
                else if (i.type === 'cash') { return `<div class="text-xs text-emerald-600 font-bold font-bold font-bold">é‡‘é¡: $${i.price.toLocaleString()}</div>`; }
                return `<div class="text-xs text-slate-600 font-bold font-bold font-bold font-bold font-bold font-bold font-bold font-bold">å–®åƒ¹: $${i.price} | å¼µæ•¸: ${i.amount}</div>`;
            },
            getLabel(t) { return {buy:'ğŸ”µ è²·å…¥', sell:'ğŸ”´ è³£å‡º', div:'ğŸ’° é…æ¯', loan:'ğŸ¦ è³ªæŠ¼', credit_loan:'ğŸ¦ ä¿¡è²¸', interest_expense:'â– åˆ©æ¯', stock:'ğŸ“ˆ è‚¡ç¥¨', cash:'ğŸ’µ ç¾é‡‘'}[t] || t; },
            closeAllModals() { document.getElementById('modalOverlay').classList.add('hidden'); ['dataModal','settingsModal','priceModal','excelModal','versionModal','helpModal'].forEach(m=>document.getElementById(m).classList.add('hidden')); },
            openModal() { this.closeAllModals(); document.getElementById('modalOverlay').classList.replace('hidden','flex'); document.getElementById('dataModal').classList.remove('hidden'); document.getElementById('editId').value=''; this.toggleFormFields(); },
            openSettingsModal() { this.closeAllModals(); document.getElementById('settingsModal').classList.remove('hidden'); },
            openVersionModal() { this.renderVersionHistory(); this.closeAllModals(); document.getElementById('modalOverlay').classList.replace('hidden','flex'); document.getElementById('versionModal').classList.remove('hidden'); },
            openPriceModal() { this.closeAllModals(); document.getElementById('modalOverlay').classList.replace('hidden','flex'); document.getElementById('priceModal').classList.remove('hidden'); document.getElementById('mPriceInput').value = state.marketPrice; },
            openExcelModal() { this.closeAllModals(); document.getElementById('modalOverlay').classList.replace('hidden','flex'); document.getElementById('excelModal').classList.remove('hidden'); },
            showHelp(title, content) { this.closeAllModals(); document.getElementById('modalOverlay').classList.replace('hidden', 'flex'); document.getElementById('helpTitle').innerText = title; document.getElementById('helpContent').innerHTML = content; document.getElementById('helpModal').classList.remove('hidden'); },
            closeHelp() { document.getElementById('helpModal').classList.add('hidden'); document.getElementById('modalOverlay').classList.add('hidden'); },
            closeVersionModal() { document.getElementById('versionModal').classList.add('hidden'); document.getElementById('modalOverlay').classList.add('hidden'); },
            toggleFormFields() {
                const t = document.getElementById('fType').value; const isC=(t==='credit_loan'), isS=(t==='stock'), isCash=(t==='cash');
                document.getElementById('stockFields').classList.toggle('hidden', !isS); document.getElementById('fCreditGroup').classList.toggle('hidden', !isC);
                document.getElementById('fRateGroup').classList.toggle('hidden', t!=='loan' && !isC); document.getElementById('fEndDateGroup').classList.toggle('hidden', t!=='loan');
                document.getElementById('fCollateralGroup').classList.toggle('hidden', t!=='loan'); document.getElementById('fDivPerShareGroup').classList.toggle('hidden', t!=='div');
                document.getElementById('fAmountGroup').classList.toggle('hidden', isC || t==='loan' || isCash);
            }
        };

        const DATA = {
            init() { const r = localStorage.getItem(CONFIG.DB_KEY); const p = localStorage.getItem(CONFIG.PRICE_KEY); if (p) state.marketPrice = parseFloat(p) || CONFIG.INITIAL_PRICE; state.db = r ? JSON.parse(r) : []; },
            saveRecord() {
                const id = document.getElementById('editId').value;
                const r = {
                    id: id || Date.now() + Math.random(), location: document.getElementById('fLocation').value, type: document.getElementById('fType').value,
                    date: document.getElementById('fDate').value, endDate: document.getElementById('fEndDate').value,
                    amount: parseFloat(document.getElementById('fAmount').value)||0, price: parseFloat(document.getElementById('fPrice').value)||0,
                    rate: parseFloat(document.getElementById('fRate').value)||0, totalTerm: parseFloat(document.getElementById('fTotalTerm').value)||0,
                    remainingTerm: parseFloat(document.getElementById('fRemainingTerm').value)||0, dueDay: parseFloat(document.getElementById('fDueDay').value)||0,
                    customEMI: parseFloat(document.getElementById('fCustomEMI').value)||0, customBalance: parseFloat(document.getElementById('fCustomBalance').value)||0,
                    comment: document.getElementById('fComment').value || '', divPerShare: parseFloat(document.getElementById('fDivPerShare').value)||0,
                    collateralAmount: parseFloat(document.getElementById('fCollateral').value)||0, symbol: document.getElementById('fSymbol').value
                };
                state.db = id ? state.db.map(x => x.id == id ? r : x) : [...state.db, r]; this.sync(); UI.closeAllModals(); UI.renderAll();
            },
            editRecord(id) {
                const r = state.db.find(i => i.id == id); if (!r) return; UI.openModal();
                document.getElementById('editId').value = r.id; document.getElementById('fLocation').value = r.location;
                document.getElementById('fType').value = r.type; document.getElementById('fDate').value = r.date;
                document.getElementById('fPrice').value = r.price; document.getElementById('fRate').value = r.rate;
                document.getElementById('fTotalTerm').value = r.totalTerm || ''; document.getElementById('fRemainingTerm').value = r.remainingTerm || '';
                document.getElementById('fDueDay').value = r.dueDay || ''; document.getElementById('fCustomEMI').value = r.customEMI || '';
                document.getElementById('fCustomBalance').value = r.customBalance || ''; document.getElementById('fComment').value = r.comment;
                document.getElementById('fAmount').value = r.amount; document.getElementById('fDivPerShare').value = r.divPerShare;
                document.getElementById('fCollateral').value = r.collateralAmount; document.getElementById('fSymbol').value = r.symbol || '';
                UI.toggleFormFields();
            },
            deleteRecord(id) { if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')){ state.db=state.db.filter(i=>i.id!=id); this.sync(); UI.renderAll(); } },
            sync() { localStorage.setItem(CONFIG.DB_KEY, JSON.stringify(state.db)); },
            resetAll() { if(confirm('é‡è¨­æ‰€æœ‰è³‡æ–™ï¼Ÿ')){ localStorage.clear(); location.reload(); } },
            updateManualPrice() { const v = parseFloat(document.getElementById('mPriceInput').value); if(v>0){ state.marketPrice=v; localStorage.setItem(CONFIG.PRICE_KEY, v); UI.closeAllModals(); UI.renderAll(); } },
            exportJSON() {
                const n = new Date(); const ts = `${n.getFullYear()}${(n.getMonth()+1).toString().padStart(2,'0')}${n.getDate().toString().padStart(2,'0')}_${n.getHours().toString().padStart(2,'0')}${n.getMinutes().toString().padStart(2,'0')}`;
                const b = new Blob([JSON.stringify(state.db, null, 2)], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `assets_backup_${ts}.json`; a.click();
            },
            triggerImport() { document.getElementById('importFile').click(); },
            handleFileImport(e) { const f = e.target.files[0]; const reader = new FileReader(); reader.onload = (ev) => { try { state.db = JSON.parse(ev.target.result); this.sync(); location.reload(); } catch(e) { alert('æ ¼å¼éŒ¯èª¤'); } }; reader.readAsText(f); },
            processExcel() {
                const raw = document.getElementById('excelPasteArea').value; const lines = raw.trim().split('\n'); let count = 0;
                lines.forEach(line => { const cols = line.split('\t'); if (cols.length >= 3) { state.db.push({ id: Date.now() + Math.random(), location: 'domestic', type: 'buy', date: cols[0].trim().replace(/\//g, '-'), amount: parseFloat(cols[1].trim()), price: parseFloat(cols[2].trim()) }); count++; } });
                if (count > 0) { this.sync(); UI.renderAll(); UI.closeAllModals(); alert(`æˆåŠŸåŒ¯å…¥ ${count} ç­†`); }
            },
            syncToLine() {
                const n = new Date(); const ts = `${n.getFullYear()}/${n.getMonth()+1}/${n.getDate()} ${n.getHours()}:${n.getMinutes()}`;
                const c = `è³‡ç”¢å‚™ä»½ V2026 (${ts})\n\nè³‡æ–™ç­†æ•¸: ${state.db.length}\nå‚™ä»½å…§å®¹:\n${JSON.stringify(state.db)}`;
                window.location.href = `line://msg/text/?${encodeURIComponent(c)}`;
            }
        };

        window.onload = () => { DATA.init(); API.fetchPrices(); UI.renderAll(); };
    </script>
</body>
</html>